<!doctype html><html lang=en-us dir=ltr>
<head><meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="连接各个内网机器间的网络"><title>在 Ubuntu20.04 建设 openVPN</title>
<link rel=canonical href=https://mkbooks.github.io/blog/p/%E5%9C%A8-ubuntu20.04-%E5%BB%BA%E8%AE%BE-openvpn/>
<link rel=stylesheet href=/blog/scss/style.min.ac77dcf8b111b51da39a92990f431923f210f3876d85798a2125667f96dc33a4.css><meta property="og:title" content="在 Ubuntu20.04 建设 openVPN">
<meta property="og:description" content="连接各个内网机器间的网络">
<meta property="og:url" content="https://mkbooks.github.io/blog/p/%E5%9C%A8-ubuntu20.04-%E5%BB%BA%E8%AE%BE-openvpn/">
<meta property="og:site_name" content="我的空间">
<meta property="og:type" content="article"><meta property="article:section" content="Post"><meta property="article:tag" content="网络"><meta property="article:tag" content="openVPN"><meta property="article:published_time" content="2020-08-06T00:00:00+00:00"><meta property="article:modified_time" content="2020-08-06T00:00:00+00:00">
<meta name=twitter:title content="在 Ubuntu20.04 建设 openVPN">
<meta name=twitter:description content="连接各个内网机器间的网络">
</head>
<body class=article-page>
<script>(function(){const a='StackColorScheme';localStorage.getItem(a)||localStorage.setItem(a,"auto")})()</script><script>(function(){const b='StackColorScheme',a=localStorage.getItem(b),c=window.matchMedia('(prefers-color-scheme: dark)').matches===!0;a=='dark'||a==='auto'&&c?document.documentElement.dataset.scheme='dark':document.documentElement.dataset.scheme='light'})()</script>
<div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky">
<button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label=切换菜单>
<span class=hamburger-box>
<span class=hamburger-inner></span>
</span>
</button>
<header>
<figure class=site-avatar>
<a href=/blog/>
<img src=/blog/img/1_hu8b5a3db4a21c8e092ed8817bbbdf793a_61250_300x0_resize_q75_box.jpg width=300 height=300 class=site-logo loading=lazy alt=Avatar>
</a>
<span class=emoji>🍥</span>
</figure>
<div class=site-meta>
<h1 class=site-name><a href=/blog>我的空间</a></h1>
<h2 class=site-description>常香玉&陈金鑫.</h2>
</div>
</header><ol class=social-menu>
<li>
<a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank title=GitHub><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"/></svg>
</a>
</li>
<li>
<a href=https://twitter.com target=_blank title=Twitter><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-twitter" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M22 4.01c-1 .49-1.98.689-3 .99-1.121-1.265-2.783-1.335-4.38-.737S11.977 6.323 12 8v1c-3.245.083-6.135-1.395-8-4 0 0-4.182 7.433 4 11-1.872 1.247-3.739 2.088-6 2 3.308 1.803 6.913 2.423 10.034 1.517 3.58-1.04 6.522-3.723 7.651-7.742a13.84 13.84.0 00.497-3.753C20.18 7.773 21.692 5.25 22 4.009z"/></svg>
</a>
</li>
</ol><ol class=menu id=main-menu>
<li>
<a href=/blog/blog/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg>
<span>Home</span>
</a>
</li>
<li>
<a href=/blog/blog/about/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="7" r="4"/><path d="M6 21v-2a4 4 0 014-4h4a4 4 0 014 4v2"/></svg>
<span>About</span>
</a>
</li>
<li>
<a href=/blog/blog/archives/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg>
<span>Archives</span>
</a>
</li>
<li>
<a href=/blog/blog/search/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg>
<span>Search</span>
</a>
</li>
<li>
<a href=/blog/blog/links/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M10 14a3.5 3.5.0 005 0l4-4a3.5 3.5.0 00-5-5l-.5.5"/><path d="M14 10a3.5 3.5.0 00-5 0l-4 4a3.5 3.5.0 005 5l.5-.5"/></svg>
<span>Links</span>
</a>
</li>
<div class=menu-bottom-section>
<li id=i18n-switch><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-language" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M4 5h7"/><path d="M9 3v2c0 4.418-2.239 8-5 8"/><path d="M5 9c-.003 2.144 2.952 3.908 6.7 4"/><path d="M12 20l4-9 4 9"/><path d="M19.1 18h-6.2"/></svg>
<select name=language onchange="window.location.href=this.selectedOptions[0].value"><option value=https://mkbooks.github.io/blog/en/>English</option><option value=https://mkbooks.github.io/blog/ selected>中文</option></select>
</li>
<li id=dark-mode-toggle><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<span>暗色模式</span>
</li>
</div>
</ol>
</aside>
<main class="main full-width">
<article class=main-article>
<header class=article-header>
<div class=article-details>
<header class=article-category>
<a href=/blog/categories/%E7%BD%91%E7%BB%9C/>
网络
</a>
<a href=/blog/categories/openvpn/>
openVPN
</a>
</header>
<div class=article-title-wrapper>
<h2 class=article-title>
<a href=/blog/p/%E5%9C%A8-ubuntu20.04-%E5%BB%BA%E8%AE%BE-openvpn/>在 Ubuntu20.04 建设 openVPN</a>
</h2>
<h3 class=article-subtitle>
连接各个内网机器间的网络
</h3>
</div>
<footer class=article-time>
<div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg>
<time class=article-time--published>Aug 06, 2020</time>
</div>
<div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<time class=article-time--reading>
阅读时长: 15 分钟
</time>
</div>
</footer>
</div>
</header>
<section class=article-content>
<h1 id=openvpn>openvpn</h1>
<p>操作系统: Ubuntu 20.04</p>
<p>参考文档：</p>
<p><a class=link href=https://openvpn.net/community-resources/ target=_blank rel=noopener>openVPN官方文档</a></p>
<p><a class=link href=https://www.digitalocean.com/community/tutorials/how-to-set-up-and-configure-an-openvpn-server-on-ubuntu-20-04 target=_blank rel=noopener>DigitalOcean官方文档</a></p>
<h2 id=初始服务器设置>初始服务器设置</h2>
<h3 id=openvpn-服务器>OpenVPN 服务器</h3>
<h4 id=创建新用户>创建新用户</h4>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback>sudo adduser sammy

# 授予 sudo 权限
sudo usermod -aG sudo sammy

# 切换用户
su sammy
</code></pre></td></tr></table>
</div>
</div><h5 id=创建密钥对>创建密钥对</h5>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback>ssh-keygen

# 将公钥复制到本机
touch ~/.ssh/authorized_keys &amp;&amp; cat ~/.ssh/id_rsa.pub &gt;&gt; ~/.ssh/authorized_keys
</code></pre></td></tr></table>
</div>
</div><h3 id=ca-服务器>CA 服务器</h3>
<h4 id=创建新用户-1>创建新用户</h4>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback>sudo adduser sammy

# 授予 sudo 权限
sudo usermod -aG sudo sammy

# 切换用户
su sammy
</code></pre></td></tr></table>
</div>
</div><h5 id=创建密钥对-1>创建密钥对</h5>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback>ssh-keygen

# 将公钥复制到本机
touch ~/.ssh/authorized_keys &amp;&amp; cat ~/.ssh/id_rsa.pub &gt;&gt; ~/.ssh/authorized_keys

# 将公钥复制到 OpenVPN 服务器
cat ~/.ssh/id_rsa.pub
# 将上面命令执行结果复制到 OpenVPN 服务器的 /home/sammy/.ssh/authorized_keys 文件中

# 将 OpenVPN 服务器的公钥复制到本机，在 OpenVPN 服务器执行下面命令:
cat ~/.ssh/id_rsa.pub
# 将上面命令执行结果复制到 CA 服务器的 /home/sammy/.ssh/authorized_keys 文件中
</code></pre></td></tr></table>
</div>
</div><h4 id=安装-easy-rsa>安装 Easy-RSA</h4>
<blockquote>
<p>版本：3.0.6。</p>
</blockquote>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback>sudo apt update
sudo apt install easy-rsa

# 查看版本：
dpkg -l|grep easy-rsa
ii  easy-rsa                              3.0.6-1                               all          Simple shell based CA utility
</code></pre></td></tr></table>
</div>
</div><h4 id=创建公开密码匙基础建设目录>创建公开密码匙基础建设目录</h4>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback>mkdir ~/easy-rsa

# 使用此目录创建指向前一步中安装的 easy-rsa 包文件的符号链接。
ln -s /usr/share/easy-rsa/* ~/easy-rsa/

# 确保只有所有者可以使用 chmod 命令访问它:
chmod 700 /home/sammy/easy-rsa
</code></pre></td></tr></table>
</div>
</div><p>在 easy-rsa 目录中初始化 PKI:</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback>cd ~/easy-rsa
./easyrsa init-pki
</code></pre></td></tr></table>
</div>
</div><h4 id=创建证书颁发机构>创建证书颁发机构</h4>
<p>创建并用一些默认值填充一个名为 vars 的文件。</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback>vi vars
cat vars

set_var EASYRSA_REQ_COUNTRY    &#34;CN&#34;
set_var EASYRSA_REQ_PROVINCE   &#34;GuangDong&#34;
set_var EASYRSA_REQ_CITY       &#34;ShenZhen&#34;
set_var EASYRSA_REQ_ORG        &#34;KLB&#34;
set_var EASYRSA_REQ_EMAIL      &#34;chenjinxin@chenjinxin.cn&#34;
set_var EASYRSA_REQ_OU         &#34;Community&#34;
set_var EASYRSA_ALGO           &#34;ec&#34;
set_var EASYRSA_DIGEST         &#34;sha512&#34;
</code></pre></td></tr></table>
</div>
</div><p>为证书颁发机构创建根公钥和私钥对(不想每次与 CA 交互时都被提示输入密码，可以使用 nopass 选项运行 build-CA 命令)</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback># 按 ENTER 接受默认配置
./easyrsa build-ca nopass
</code></pre></td></tr></table>
</div>
</div><h2 id=安装-openvpn-和-easy-rsa>安装 OpenVPN 和 Easy-RSA</h2>
<h3 id=openvpn-服务器-1>OpenVPN 服务器</h3>
<p>更新 OpenVPN 服务器的软件包索引并安装 OpenVPN 和 Easy-RSA。</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback>sudo apt update
sudo apt install openvpn easy-rsa

# 查看版本
dpkg -l|grep easy-rsa
ii  easy-rsa                              3.0.6-1                               all          Simple shell based CA utility
openvpn --version
OpenVPN 2.5.5 x86_64-pc-linux-gnu [SSL (OpenSSL)] [LZO] [LZ4] [EPOLL] [PKCS11] [MH/PKTINFO] [AEAD] built on Mar 22 2022
library versions: OpenSSL 3.0.2 15 Mar 2022, LZO 2.10
......
</code></pre></td></tr></table>
</div>
</div><p>在 OpenVPN 服务器上创建一个新目录 ~/easy-rsa, 从 easyrsa 包安装到 ~/easy-rsa 目录中的脚本创建一个符号链接:</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback>mkdir ~/easy-rsa
ln -s /usr/share/easy-rsa/* ~/easy-rsa/

# 确保目录的所有者是您的非 root sudo 用户，并使用chmod以下命令限制对该用户的访问：
sudo chown sammy ~/easy-rsa
chmod 700 ~/easy-rsa
</code></pre></td></tr></table>
</div>
</div><h2 id=为-openvpn-创建-pki>为 OpenVPN 创建 PKI</h2>
<h3 id=openvpn-服务器-2>OpenVPN 服务器</h3>
<p>在创建 OpenVPN 服务器的私钥和证书之前，您需要在 OpenVPN 服务器上创建一个本地公钥基础设施目录。您将使用此目录来管理服务器和客户端的证书请求，而不是直接在您的 CA 服务器上进行。</p>
<p>要在您的 OpenVPN 服务器上构建 PKI 目录，您需要填充一个 vars 使用一些默认值调用的文件。首先您将 cd 进入该 easy-rsa 目录，然后您将使用 vi 或您喜欢的文本编辑器创建和编辑文件。</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback>cd ~/easy-rsa
vi vars
</code></pre></td></tr></table>
</div>
</div><p>打开文件后，粘贴以下两行：</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback>set_var EASYRSA_ALGO &#34;ec&#34;
set_var EASYRSA_DIGEST &#34;sha512&#34;
</code></pre></td></tr></table>
</div>
</div><p>填充 vars 文件后，您可以继续创建 PKI 目录。为此，请 easyrsa 使用该 init-pki 选项运行脚本。</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback>./easyrsa init-pki
</code></pre></td></tr></table>
</div>
</div><h2 id=创建-openvpn-服务器证书请求和私钥>创建 OpenVPN 服务器证书请求和私钥</h2>
<h3 id=openvpn-服务器-3>OpenVPN 服务器</h3>
<p>生成私钥和证书签名请求</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback>cd ~/easy-rsa
</code></pre></td></tr></table>
</div>
</div><p>现在，您将 easyrsa 使用该 gen-req 选项后跟机器的通用名称 (CN) 来调用。CN 可以是您喜欢的任何内容，但使其具有描述性会很有帮助。在本教程中，OpenVPN 服务器的 CN 将是server. 一定要包括该nopass选项。如果不这样做，将对请求文件进行密码保护，这可能会导致以后出现权限问题。</p>
<p>注意：如果您选择server此处以外的名称，则必须调整下面的一些说明。例如，将生成的文件复制到/etc/openvpn目录时，您必须替换正确的名称。您还必须/etc/openvpn/server.conf稍后修改该文件以指向正确的.crt和.key文件。</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback>./easyrsa gen-req server nopass
</code></pre></td></tr></table>
</div>
</div><div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback>Output
Common Name (eg: your user, host, or server name) [server]:

Keypair and certificate request completed. Your files are:
req: /home/sammy/easy-rsa/pki/reqs/server.req
key: /home/sammy/easy-rsa/pki/private/server.key
</code></pre></td></tr></table>
</div>
</div><p>这将为服务器创建一个私钥和一个名为server.req. 将服务器密钥复制到/etc/openvpn/server目录：</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback>sudo cp /home/sammy/easy-rsa/pki/private/server.key /etc/openvpn/server/
</code></pre></td></tr></table>
</div>
</div><h2 id=签署-openvpn-服务器的证书请求>签署 OpenVPN 服务器的证书请求</h2>
<h3 id=ca-服务器-1>CA 服务器</h3>
<p>在 OpenVPN 服务器上，作为您的非 root 用户，使用 SCP 或其他传输方法将 server.req 证书请求复制到 CA 服务器进行签名：</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback># scp sammy@your_openvpn_server_ip:/home/sammy/easy-rsa/pki/reqs/server.req /tmp
scp sammy@123.125.32.26:/home/sammy/easy-rsa/pki/reqs/server.req /tmp
</code></pre></td></tr></table>
</div>
</div><p>进入 ~/easy-rsa 创建 PK 的目录，然后使用easyrsa脚本导入证书请求：</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback>cd ~/easy-rsa
./easyrsa import-req /tmp/server.req server
</code></pre></td></tr></table>
</div>
</div><div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback>Output
...
The request has been successfully imported with a short name of: server
You may now use this name to perform signing operations on this request.
</code></pre></td></tr></table>
</div>
</div><p>接下来，通过运行easyrsa带有sign-req选项的脚本来签署请求，后跟请求类型和通用名称。请求类型可以是client或server。由于我们正在处理 OpenVPN 服务器的证书请求，请务必使用server请求类型：</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback>./easyrsa sign-req server server
</code></pre></td></tr></table>
</div>
</div><p>在输出中，系统会提示您验证请求是否来自受信任的来源。输入yes然后按ENTER确认：</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback>Output
Note: using Easy-RSA configuration from: ./vars

Using SSL: openssl OpenSSL 1.1.1f  31 Mar 2020


You are about to sign the following certificate.
Please check over the details shown below for accuracy. Note that this request
has not been cryptographically verified. Please be sure it came from a trusted
source or that you have verified the request checksum with the sender.

Request subject, to be signed as a server certificate for 1080 days:

subject=
    commonName                = server


Type the word &#39;yes&#39; to continue, or any other input to abort.
  Confirm request details: yes
Using configuration from /home/sammy/easy-rsa/pki/safessl-easyrsa.cnf
Check that the request matches the signature
Signature ok
The Subject&#39;s Distinguished Name is as follows
commonName            :ASN.1 12:&#39;server&#39;
Certificate is to be certified until Jul  6 05:46:50 2025 GMT (1080 days)

Write out database with 1 new entries
Data Base Updated

Certificate created at: /home/sammy/easy-rsa/pki/issued/server.crt
</code></pre></td></tr></table>
</div>
</div><p>完成这些步骤后，您已经使用 CA 服务器的私钥签署了 OpenVPN 服务器的证书请求。生成的server.crt文件包含 OpenVPN 服务器的公共加密密钥，以及来自 CA 服务器的签名。签名的目的是告诉任何信任 CA 服务器的人，当他们连接到 OpenVPN 服务器时，他们也可以信任它。</p>
<p>要完成配置证书，请将server.crt和ca.crt文件从 CA 服务器复制到 OpenVPN 服务器：</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback># scp pki/issued/server.crt sammy@your_vpn_server_ip:/tmp
# scp pki/ca.crt sammy@your_vpn_server_ip:/tmp
scp pki/issued/server.crt sammy@123.125.32.26:/tmp
scp pki/ca.crt sammy@123.125.32.26:/tmp
</code></pre></td></tr></table>
</div>
</div><h3 id=openvpn-服务器-4>OpenVPN 服务器</h3>
<p>现在回到您的 OpenVPN 服务器，将文件复制 /tmp 到 /etc/openvpn/server：</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback>sudo cp /tmp/{server.crt,ca.crt} /etc/openvpn/server
</code></pre></td></tr></table>
</div>
</div><h2 id=配置-openvpn-加密材料>配置 OpenVPN 加密材料</h2>
<h3 id=openvpn-服务器-5>OpenVPN 服务器</h3>
<p>为了增加一层安全性，我们将添加一个额外的共享密钥，服务器和所有客户端将使用OpenVPN 的tls-crypt指令。此选项用于混淆服务器和客户端最初相互连接时使用的 TLS 证书。OpenVPN 服务器也使用它来对传入的数据包执行快速检查：如果使用预共享密钥对数据包进行签名，则服务器会对其进行处理；如果它没有签名，那么服务器知道它来自不受信任的来源并且可以丢弃它而不必执行额外的解密工作。</p>
<p>此选项将有助于确保您的 OpenVPN 服务器能够应对未经身份验证的流量、端口扫描和拒绝服务攻击，这些攻击会占用服务器资源。这也使得识别 OpenVPN 网络流量变得更加困难。</p>
<p>要生成tls-crypt预共享密钥，请在 OpenVPN 服务器上的~/easy-rsa目录中运行以下命令：</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback>cd ~/easy-rsa
openvpn --genkey secret ta.key
</code></pre></td></tr></table>
</div>
</div><p>结果将是一个名为ta.key. 复制到/etc/openvpn/server/目录：</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback>sudo cp ta.key /etc/openvpn/server
</code></pre></td></tr></table>
</div>
</div><p>将这些文件放在 OpenVPN 服务器上后，您就可以为您的用户创建客户端证书和密钥文件，您将使用它们连接到 VPN。</p>
<h2 id=生成客户端证书和密钥对>生成客户端证书和密钥对</h2>
<h3 id=openvpn-服务器-6>OpenVPN 服务器</h3>
<p>尽管您可以在客户端计算机上生成私钥和证书请求，然后将其发送到 CA 进行签名，但本指南概述了在 OpenVPN 服务器上生成证书请求的过程。这种方法的好处是我们可以创建一个脚本，该脚本将自动生成包含所有必需密钥和证书的客户端配置文件。这让您不必将密钥、证书和配置文件传输到客户端，并简化加入 VPN 的过程。</p>
<p>我们将为本指南生成单个客户端密钥和证书对。如果您有多个客户，您可以对每个客户重复此过程。但请注意，您需要为每个客户端的脚本传递一个唯一的名称值。在本教程中，第一个证书/密钥对称为 client1.</p>
<p>首先在您的主目录中创建一个目录结构来存储客户端证书和密钥文件：</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback>mkdir -p ~/client-configs/keys
</code></pre></td></tr></table>
</div>
</div><p>由于您将客户的证书/密钥对和配置文件存储在此目录中，因此您现在应该锁定其权限作为安全措施：</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback>chmod -R 700 ~/client-configs
</code></pre></td></tr></table>
</div>
</div><p>接下来，导航回 EasyRSA 目录并 easyrsa 使用gen-req 和nopass 选项以及客户端的通用名称运行脚本：</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback>cd ~/easy-rsa
./easyrsa gen-req client1 nopass
</code></pre></td></tr></table>
</div>
</div><p>按 ENTER 确认常用名称。然后，将 client1.key 文件复制到 ~/client-configs/keys/ 您之前创建的目录中：</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback>cp pki/private/client1.key ~/client-configs/keys/
</code></pre></td></tr></table>
</div>
</div><h3 id=ca-服务器-2>CA 服务器</h3>
<p>现在登录到您的 CA 服务器。</p>
<p>接下来，将 client1.req 使用安全方法将文件传输到您的 CA 服务器：</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback># scp sammy@your_openvpn_server_ip:/home/sammy/easy-rsa/pki/reqs/client1.req /tmp
scp sammy@123.125.32.26:/home/sammy/easy-rsa/pki/reqs/client1.req /tmp
</code></pre></td></tr></table>
</div>
</div><p>然后，导航到 EasyRSA 目录，并导入证书请求：</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback>cd ~/easy-rsa
./easyrsa import-req /tmp/client1.req client1
</code></pre></td></tr></table>
</div>
</div><p>接下来，以与您在上一步中为服务器所做的相同的方式签署请求。不过这一次，请务必指定client请求类型：</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback>./easyrsa sign-req client client1
</code></pre></td></tr></table>
</div>
</div><p>出现提示时，输入yes以确认您打算签署证书请求并且它来自受信任的来源：</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback>Output
Note: using Easy-RSA configuration from: ./vars

Using SSL: openssl OpenSSL 1.1.1f  31 Mar 2020


You are about to sign the following certificate.
Please check over the details shown below for accuracy. Note that this request
has not been cryptographically verified. Please be sure it came from a trusted
source or that you have verified the request checksum with the sender.

Request subject, to be signed as a client certificate for 1080 days:

subject=
    commonName                = client1


Type the word &#39;yes&#39; to continue, or any other input to abort.
  Confirm request details: yes
Using configuration from /home/sammy/easy-rsa/pki/safessl-easyrsa.cnf
Check that the request matches the signature
Signature ok
The Subject&#39;s Distinguished Name is as follows
commonName            :ASN.1 12:&#39;client1&#39;
Certificate is to be certified until Jul  6 06:18:09 2025 GMT (1080 days)

Write out database with 1 new entries
Data Base Updated

Certificate created at: /home/sammy/easy-rsa/pki/issued/client1.crt
</code></pre></td></tr></table>
</div>
</div><p>这将创建一个名为client1.crt. 将此文件传输回服务器：</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback># scp pki/issued/client1.crt sammy@your_server_ip:/tmp
scp pki/issued/client1.crt sammy@123.125.32.26:/tmp
</code></pre></td></tr></table>
</div>
</div><h3 id=openvpn-服务器-7>OpenVPN 服务器</h3>
<p>回到您的 OpenVPN 服务器，将客户端证书复制到~/client-configs/keys/目录：</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback>cp /tmp/client1.crt ~/client-configs/keys/
</code></pre></td></tr></table>
</div>
</div><p>接下来，将 ca.crt 和 ta.key 文件也复制到 ~/client-configs/keys/ 目录中，并为您的 sudo 用户设置适当的权限：</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback>cp ~/easy-rsa/ta.key ~/client-configs/keys/
sudo cp /etc/openvpn/server/ca.crt ~/client-configs/keys/
sudo chown sammy.sammy ~/client-configs/keys/*
</code></pre></td></tr></table>
</div>
</div><p>这样，您的服务器和客户端的证书和密钥都已生成并存储在 OpenVPN 服务器上的相应目录中。仍然需要对这些文件执行一些操作，但这些将在稍后的步骤中进行。现在，您可以继续配置 OpenVPN。</p>
<h2 id=配置-openvpn>配置 OpenVPN</h2>
<h3 id=openvpn-服务器-8>OpenVPN 服务器</h3>
<p>像许多其他广泛使用的开源工具一样，OpenVPN 有许多配置选项可用于根据您的特定需求自定义您的服务器。在本节中，我们将提供有关如何根据此软件文档中包含的示例配置文件之一设置 OpenVPN 服务器配置的说明。</p>
<p>首先，复制示例 server.conf 文件作为您自己的配置文件的起点：</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback>sudo cp /usr/share/doc/openvpn/examples/sample-config-files/server.conf /etc/openvpn/server/
</code></pre></td></tr></table>
</div>
</div><p>使用您选择的文本编辑器打开新文件进行编辑。我们将在示例中使用 vi：</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback>sudo vi /etc/openvpn/server/server.conf
</code></pre></td></tr></table>
</div>
</div><p>我们需要更改此文件中的几行。首先，HMAC通过搜索 tls-auth 指令找到配置的部分。默认情况下将启用此行。通过;在行的开头添加 a来注释掉它。然后在它只包含值之后添加一个新行 tls-crypt ta.key：</p>
<p>/etc/openvpn/server/server.conf</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback>;tls-auth ta.key 0 # This file is secret
tls-crypt ta.key
</code></pre></td></tr></table>
</div>
</div><p>接下来，通过查找cipher行找到有关加密密码的部分。默认值设置为AES-256-CBC，但是，AES-256-GCM密码提供更好的加密级别和性能，并且在最新的 OpenVPN 客户端中得到很好的支持。我们将通过;在此行的开头添加一个符号来注释掉默认值，然后我们将在它包含更新后的值之后添加另一行AES-256-GCM：</p>
<p>/etc/openvpn/server/server.conf</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback>;cipher AES-256-CBC
cipher AES-256-GCM
</code></pre></td></tr></table>
</div>
</div><p>在此行之后，添加一个auth指令来选择 HMAC 消息摘要算法。为此，SHA256是一个不错的选择：</p>
<p>/etc/openvpn/server/server.conf</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback>auth SHA256
</code></pre></td></tr></table>
</div>
</div><p>接下来，找到包含dh指令的行，该指令定义了 Diffie-Hellman 参数。由于我们已将所有证书配置为使用椭圆曲线密码术，因此不需要 Diffie-Hellman 种子文件。注释掉看起来像dh dh2048.pem或的现有行dh dh.pem。Diffie-Hellman 密钥的文件名可能与示例服务器配置文件中列出的不同。然后在它后面添加一行内容dh none：</p>
<p>/etc/openvpn/server/server.conf</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback>;dh dh2048.pem
dh none
</code></pre></td></tr></table>
</div>
</div><p>接下来，我们希望 OpenVPN 一旦启动就在没有特权的情况下运行，因此我们需要告诉它以用户nobody和组nogroup 运行。要启用此功能，请通过删除每行开头的符号来查找和取消注释user nobody和行：group nogroup;</p>
<p>/etc/openvpn/server/server.conf</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback>user nobody
group nogroup
</code></pre></td></tr></table>
</div>
</div><h2 id=调整-openvpn-服务器网络配置>调整 OpenVPN 服务器网络配置</h2>
<h3 id=openvpn-服务器-9>OpenVPN 服务器</h3>
<p>服务器网络配置的某些方面需要进行调整，以便 OpenVPN 可以通过 VPN 正确路由流量。其中第一个是IP 转发，这是一种确定 IP 流量应路由到何处的方法。这对于您的服务器将提供的 VPN 功能至关重要。</p>
<p>要调整 OpenVPN 服务器的默认 IP 转发设置，请 /etc/sysctl.conf 使用 vi 或首选编辑器打开文件：</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback>sudo vi /etc/sysctl.conf
</code></pre></td></tr></table>
</div>
</div><p>然后在文件底部添加以下行：</p>
<p>/etc/sysctl.conf</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback>net.ipv4.ip_forward = 1
</code></pre></td></tr></table>
</div>
</div><p>完成后保存并关闭文件。</p>
<p>要读取文件并加载当前会话的新值，请键入：</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback>sudo sysctl -p
</code></pre></td></tr></table>
</div>
</div><div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback>Output
net.ipv4.ip_forward = 1
</code></pre></td></tr></table>
</div>
</div><p>现在，您的 OpenVPN 服务器将能够将传入流量从一个以太网设备转发到另一个。此设置确保服务器可以将连接到虚拟 VPN 接口的客户端的流量通过其其他物理以太网设备引导出去。此配置将通过服务器的 IP 地址路由来自客户端的所有网络流量，并且将有效地隐藏客户端的公共 IP 地址。</p>
<p>在下一步中，您需要配置一些防火墙规则，以确保进出 OpenVPN 服务器的流量正常流动。</p>
<h2 id=防火墙配置未开启防火墙可以跳过>防火墙配置(未开启防火墙可以跳过)</h2>
<h3 id=openvpn-服务器-10>OpenVPN 服务器</h3>
<p>到目前为止，您已经在服务器上安装了 OpenVPN，对其进行了配置，并生成了客户端访问 VPN 所需的密钥和证书。但是，您尚未向 OpenVPN 提供有关从客户端发送传入 Web 流量的位置的任何说明。您可以通过建立一些防火墙规则和路由配置来规定服务器应如何处理客户端流量。</p>
<p>假设您遵循了本教程开始时的先决条件，您应该已经ufw在服务器上安装并运行。要允许 OpenVPN 通过防火墙，您需要启用伪装，这是一种 iptables 概念，可提供即时动态网络地址转换 (NAT) 以正确路由客户端连接。</p>
<p>在打开防火墙配置文件添加伪装规则之前，首先要找到自己机器的公网接口。为此，请键入：</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback>ip route list default
</code></pre></td></tr></table>
</div>
</div><p>您的公共接口是在此命令的输出中找到的跟在单词“dev”之后的字符串。例如，此结果显示名为 的接口eth0，它在下面突出显示：</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback>Output
default via 159.65.160.1 dev eth0 proto static
</code></pre></td></tr></table>
</div>
</div><p>当您拥有与默认路由关联的接口时，打开 /etc/ufw/before.rules 文件以添加相关配置：</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback>sudo nano /etc/ufw/before.rules
</code></pre></td></tr></table>
</div>
</div><p>UFW 规则通常使用该ufw命令添加。before.rules但是，在加载传统 UFW 规则之前，会读取文件中列出的规则并将其放置到位。在文件顶部，添加下面突出显示的行。这将为表中的POSTROUTING链设置默认策略nat并伪装来自 VPN 的任何流量。请记住eth0将以-A POSTROUTING下行中的内容替换为您在上述命令中找到的界面：</p>
<p>/etc/ufw/before.rules</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback>#
# rules.before
#
# Rules that should be run before the ufw command line added rules. Custom
# rules should be added to one of these chains:
#   ufw-before-input
#   ufw-before-output
#   ufw-before-forward
#

# START OPENVPN RULES
# NAT table rules
*nat
:POSTROUTING ACCEPT [0:0]
# Allow traffic from OpenVPN client to eth0 (change to the interface you discovered!)
-A POSTROUTING -s 10.8.0.0/8 -o eth0 -j MASQUERADE
COMMIT
# END OPENVPN RULES

# Don&#39;t delete these required lines, otherwise there will be errors
*filter
. . .
</code></pre></td></tr></table>
</div>
</div><p>完成后保存并关闭文件。</p>
<p>接下来，您需要告诉 UFW 默认情况下也允许转发数据包。为此，请打开 /etc/default/ufw 文件：</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback>sudo nano /etc/default/ufw
</code></pre></td></tr></table>
</div>
</div><p>在里面，找到DEFAULT_FORWARD_POLICY指令并将值从 更改 DROP 为 ACCEPT ：</p>
<p>/etc/default/ufw</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback>DEFAULT_FORWARD_POLICY=&#34;ACCEPT&#34;
</code></pre></td></tr></table>
</div>
</div><p>完成后保存并关闭文件。</p>
<p>接下来，调整防火墙本身以允许 OpenVPN 的流量。如果您没有更改文件中的端口和协议/etc/openvpn/server.conf，则需要打开 UDP 流量到 port 1194。如果您修改了端口和/或协议，请替换您在此处选择的值。</p>
<p>如果您在遵循先决条件教程时忘记添加 SSH 端口，请在此处添加：</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback>sudo ufw allow 1194/udp
sudo ufw allow OpenSSH
</code></pre></td></tr></table>
</div>
</div><p>注意：如果您使用不同的防火墙或自定义了 UFW 配置，则可能需要添加其他防火墙规则。例如，如果你决定隧道所有的网络流量通过VPN连接，你需要确保端口53流量允许DNS请求，而像港口80和443分别为HTTP和HTTPS流量。如果您在 VPN 上使用了其他协议，那么您还需要为它们添加规则。</p>
<p>添加这些规则后，禁用并重新启用 UFW 以重新启动它并从您修改的所有文件中加载更改：</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback>sudo ufw disable
sudo ufw enable
</code></pre></td></tr></table>
</div>
</div><p>您的服务器现已配置为正确处理 OpenVPN 流量。设置好防火墙规则后，我们可以在服务器上启动 OpenVPN 服务。</p>
<h2 id=启动-openvpn>启动 OpenVPN</h2>
<h3 id=openvpn-服务器-11>OpenVPN 服务器</h3>
<p>OpenVPN 作为 systemd 服务运行，因此我们可以使用 systemctl 它来管理它。我们会将 OpenVPN 配置为在启动时启动，因此只要您的服务器正在运行，您就可以随时连接到您的 VPN。为此，请将 OpenVPN 服务添加到 systemctl：</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback>sudo systemctl -f enable openvpn-server@server.service
</code></pre></td></tr></table>
</div>
</div><p>然后启动OpenVPN服务：</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback>sudo systemctl start openvpn-server@server.service
</code></pre></td></tr></table>
</div>
</div><p>使用以下命令仔细检查 OpenVPN 服务是否处于活动状态。您应该active (running)在输出中看到：</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback>sudo systemctl status openvpn-server@server.service
</code></pre></td></tr></table>
</div>
</div><div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback>Output
● openvpn-server@server.service - OpenVPN service for server
     Loaded: loaded (/lib/systemd/system/openvpn-server@.service; enabled; vendor preset: enabled)
     Active: active (running) since Wed 2020-04-29 15:39:59 UTC; 6s ago
       Docs: man:openvpn(8)
             https://community.openvpn.net/openvpn/wiki/Openvpn24ManPage
             https://community.openvpn.net/openvpn/wiki/HOWTO
   Main PID: 16872 (openvpn)
     Status: &#34;Initialization Sequence Completed&#34;
      Tasks: 1 (limit: 1137)
     Memory: 1.0M
     CGroup: /system.slice/system-openvpn\x2dserver.slice/openvpn-server@server.service
             └─16872 /usr/sbin/openvpn --status /run/openvpn-server/status-server.log --status-version 2 --suppress-timestamps --c&gt;
. . .
. . .
Apr 29 15:39:59 ubuntu-20 openvpn[16872]: Initialization Sequence Completed
</code></pre></td></tr></table>
</div>
</div><p>我们现在已经完成了 OpenVPN 的服务器端配置。接下来，您将配置您的客户端机器并连接到 OpenVPN 服务器。</p>
<h2 id=创建客户端配置基础架构无特殊需求可以跳过>创建客户端配置基础架构(无特殊需求可以跳过)</h2>
<h3 id=openvpn-服务器-12>OpenVPN 服务器</h3>
<p>为 OpenVPN 客户端创建配置文件可能有些复杂，因为每个客户端都必须有自己的配置，并且每个客户端都必须与服务器配置文件中列出的设置保持一致。这一步不是编写只能在一个客户端上使用的单个配置文件，而是概述了构建客户端配置基础结构的过程，您可以使用它来即时生成配置文件。您将首先创建一个“基本”配置文件，然后构建一个脚本，该脚本将允许您根据需要生成唯一的客户端配置文件、证书和密钥。</p>
<p>首先创建一个新目录，您将<code>client-configs</code>在之前创建的目录中存储客户端配置文件：</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback>mkdir -p ~/client-configs/files
</code></pre></td></tr></table>
</div>
</div><p>接下来，将示例客户端配置文件复制到<code>client-configs</code>目录中以用作基本配置：</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback>cp /usr/share/doc/openvpn/examples/sample-config-files/client.conf ~/client-configs/base.conf
</code></pre></td></tr></table>
</div>
</div><p>使用<code>nano</code>或您喜欢的文本编辑器打开这个新文件：</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-bash data-lang=bash>nano ~/client-configs/base.conf
</code></pre></td></tr></table>
</div>
</div><p>在里面，找到<code>remote</code>指令。这将客户端指向您的 OpenVPN 服务器地址——您的 OpenVPN 服务器的公共 IP 地址。如果您决定更改 OpenVPN 服务器正在侦听的端口，您还需要更改<code>1194</code>为您选择的端口：</p>
<p>~/client-configs/base.conf</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback>. . .
# The hostname/IP and port of the server.
# You can have multiple remote entries
# to load balance between the servers.
remote your_server_ip 1194
. . .
</code></pre></td></tr></table>
</div>
</div><p>确保协议与您在服务器配置中使用的值匹配：</p>
<p>~/client-configs/base.conf</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback>proto udp
</code></pre></td></tr></table>
</div>
</div><p>接下来，通过删除每行开头的符号来取消对<code>user</code>and<code>group</code>指令的注释<code>;</code>：</p>
<p>~/client-configs/base.conf</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback># Downgrade privileges after initialization (non-Windows only)
user nobody
group nogroup
</code></pre></td></tr></table>
</div>
</div><p>查找设置的指示<code>ca</code>，<code>cert</code>和<code>key</code>。注释掉这些指令，因为您很快就会在文件本身中添加证书和密钥：</p>
<p>~/client-configs/base.conf</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback># SSL/TLS parms.
# See the server config file for more
# description. It&#39;s best to use
# a separate .crt/.key file pair
# for each client. A single ca
# file can be used for all clients.
;ca ca.crt
;cert client.crt
;key client.key
</code></pre></td></tr></table>
</div>
</div><p>同样，注释掉该<code>tls-auth</code>指令，因为您将<code>ta.key</code>直接添加到客户端配置文件中（并且服务器设置为使用<code>tls-crypt</code>）：</p>
<p>~/client-configs/base.conf</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback># If a tls-auth key is used on the server
# then every client must also have the key.
;tls-auth ta.key 1
</code></pre></td></tr></table>
</div>
</div><p>镜像您在文件中设置的<code>cipher</code>和<code>auth</code>设置<code>/etc/openvpn/server/server.conf</code>：</p>
<p>~/client-configs/base.conf</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback>cipher AES-256-GCM
auth SHA256
</code></pre></td></tr></table>
</div>
</div><p>接下来，<code>key-direction</code>在文件中的某处添加指令。您<strong>必须</strong>将其设置为“1”才能使 VPN 在客户端计算机上正常运行：</p>
<p>~/client-configs/base.conf</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback>key-direction 1
</code></pre></td></tr></table>
</div>
</div><p>最后，添加一些<strong>注释掉的</strong>行来处理基于 Linux 的 VPN 客户端将用于 DNS 解析的各种方法。您将添加两个相似但单独的注释行集。第一组用于<em>不</em>用于<code>systemd-resolved</code>管理 DNS 的客户端。这些客户端依靠该<code>resolvconf</code>实用程序来更新 Linux 客户端的 DNS 信息。</p>
<p>~/client-configs/base.conf</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback>; script-security 2
; up /etc/openvpn/update-resolv-conf
; down /etc/openvpn/update-resolv-conf
</code></pre></td></tr></table>
</div>
</div><p>现在为<code>systemd-resolved</code>用于 DNS 解析的客户端添加另一组行：</p>
<p>~/client-configs/base.conf</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback>; script-security 2
; up /etc/openvpn/update-systemd-resolved
; down /etc/openvpn/update-systemd-resolved
; down-pre
; dhcp-option DOMAIN-ROUTE .
</code></pre></td></tr></table>
</div>
</div><p>完成后保存并关闭文件。</p>
<p>接下来，我们将创建一个脚本，该脚本将使用相关的证书、密钥和加密文件编译您的基本配置，然后将生成的配置放在<code>~/client-configs/files</code>目录中。打开<code>make_config.sh</code>在<code>~/client-configs</code>目录中调用的新文件：</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-bash data-lang=bash>nano ~/client-configs/make_config.sh
</code></pre></td></tr></table>
</div>
</div><p>在里面，添加以下内容：</p>
<p>~/client-configs/make_config.sh</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=cp>#!/bin/bash
</span><span class=cp></span>
<span class=c1># First argument: Client identifier</span>

<span class=nv>KEY_DIR</span><span class=o>=</span>~/client-configs/keys
<span class=nv>OUTPUT_DIR</span><span class=o>=</span>~/client-configs/files
<span class=nv>BASE_CONFIG</span><span class=o>=</span>~/client-configs/base.conf

cat <span class=si>${</span><span class=nv>BASE_CONFIG</span><span class=si>}</span> <span class=se>\
</span><span class=se></span>    &lt;<span class=o>(</span><span class=nb>echo</span> -e <span class=s1>&#39;&lt;ca&gt;&#39;</span><span class=o>)</span> <span class=se>\
</span><span class=se></span>    <span class=si>${</span><span class=nv>KEY_DIR</span><span class=si>}</span>/ca.crt <span class=se>\
</span><span class=se></span>    &lt;<span class=o>(</span><span class=nb>echo</span> -e <span class=s1>&#39;&lt;/ca&gt;\n&lt;cert&gt;&#39;</span><span class=o>)</span> <span class=se>\
</span><span class=se></span>    <span class=si>${</span><span class=nv>KEY_DIR</span><span class=si>}</span>/.crt <span class=se>\
</span><span class=se></span>    &lt;<span class=o>(</span><span class=nb>echo</span> -e <span class=s1>&#39;&lt;/cert&gt;\n&lt;key&gt;&#39;</span><span class=o>)</span> <span class=se>\
</span><span class=se></span>    <span class=si>${</span><span class=nv>KEY_DIR</span><span class=si>}</span>/.key <span class=se>\
</span><span class=se></span>    &lt;<span class=o>(</span><span class=nb>echo</span> -e <span class=s1>&#39;&lt;/key&gt;\n&lt;tls-crypt&gt;&#39;</span><span class=o>)</span> <span class=se>\
</span><span class=se></span>    <span class=si>${</span><span class=nv>KEY_DIR</span><span class=si>}</span>/ta.key <span class=se>\
</span><span class=se></span>    &lt;<span class=o>(</span><span class=nb>echo</span> -e <span class=s1>&#39;&lt;/tls-crypt&gt;&#39;</span><span class=o>)</span> <span class=se>\
</span><span class=se></span>    &gt; <span class=si>${</span><span class=nv>OUTPUT_DIR</span><span class=si>}</span>/.ovpn
</code></pre></td></tr></table>
</div>
</div><p>完成后保存并关闭文件。</p>
<p>在继续之前，请确保通过键入以下内容将此文件标记为可执行文件：</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback>chmod 700 ~/client-configs/make_config.sh
</code></pre></td></tr></table>
</div>
</div><p>此脚本将复制<code>base.conf</code>您创建的文件，收集您为客户端创建的所有证书和密钥文件，提取它们的内容，将它们附加到基本配置文件的副本，并将所有这些内容导出到新的客户端配置文件。这意味着，不必单独管理客户端的配置、证书和密钥文件，所有需要的信息都存储在一个地方。使用此方法的好处是，如果您将来需要添加客户端，您可以运行此脚本来快速创建一个新的配置文件，并确保所有重要信息都存储在一个易于访问的单个地点。</p>
<p>请注意，每次添加新客户端时，您都需要为其生成新的密钥和证书，然后才能运行此脚本并生成其配置文件。您将在下一步中练习使用此脚本。</p>
<h2 id=生成客户端配置>生成客户端配置</h2>
<p>生成配置文件：</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback>cd ~/client-configs
./make_config.sh client1
</code></pre></td></tr></table>
</div>
</div><p>这将<code>client1.ovpn</code>在您的<code>~/client-configs/files</code>目录中创建一个名为的文件：</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-bash data-lang=bash>ls ~/client-configs/files
</code></pre></td></tr></table>
</div>
</div><div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback>Output
client1.ovpn
</code></pre></td></tr></table>
</div>
</div><p>您需要将此文件传输到您计划用作客户端的设备。例如，这可能是您的本地计算机或移动设备。</p>
<p>虽然用于完成此传输的确切应用程序取决于您设备的操作系统和您的个人偏好，但可靠且安全的方法是在后端使用 SFTP（SSH 文件传输协议）或 SCP（安全复制）。这将通过加密连接传输您客户端的 VPN 身份验证文件。</p>
<p>这是一个示例 SFTP 命令，您可以从本地计算机（macOS 或 Linux）运行该命令。这会将<code>client1.ovpn</code>我们在上一步中创建的文件复制到您的主目录：</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback># sftp sammy@openvpn_server_ip:client-configs/files/client1.ovpn ~/
sftp sammy@123.125.32.26:client-configs/files/client1.ovpn ~/
</code></pre></td></tr></table>
</div>
</div><h2 id=安装客户端配置>安装客户端配置</h2>
<p><strong>离线安装</strong></p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback># ubuntu20.04 系统
sudo dpkg -i pkg/ubuntu20.04/openvpn_2.4.7-1ubuntu2.20.04.4_amd64.deb
</code></pre></td></tr></table>
</div>
</div><div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback># redhat8.6 系统
sudo rpm -i pkg/redhat8.6/pkg/*
</code></pre></td></tr></table>
</div>
</div><p><strong>在线安装</strong></p>
<p>如果您使用的是 Linux，则可以根据您的发行版使用多种工具。您的桌面环境或窗口管理器可能还包括连接实用程序。</p>
<p>然而，最通用的连接方式是使用 OpenVPN 软件。</p>
<p>在 Ubuntu 或 Debian 上，您可以像在服务器上一样通过键入以下内容来安装它：</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback>sudo apt update
sudo apt install openvpn
</code></pre></td></tr></table>
</div>
</div><p>在 CentOS 上，您可以启用 EPEL 存储库，然后键入以下内容进行安装：</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-bash data-lang=bash>sudo dnf install epel-release
sudo dnf install openvpn
</code></pre></td></tr></table>
</div>
</div><h4 id=配置使用的客户端-systemd-resolved>配置使用的客户端 <code>systemd-resolved</code></h4>
<p>首先<code>systemd-resolved</code>通过检查<code>/etc/resolv.conf</code>文件来确定您的系统是否用于处理 DNS 解析：</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback>cat /etc/resolv.conf
</code></pre></td></tr></table>
</div>
</div><div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback>Output
# This file is managed by man:systemd-resolved(8). Do not edit.
. . .

nameserver 127.0.0.53
options edns0
</code></pre></td></tr></table>
</div>
</div><p>如果您的系统配置为<code>systemd-resolved</code>用于 DNS 解析，则<code>nameserver</code>选项后面的 IP 地址将为<code>127.0.0.53</code>. 文件中还应该有注释，如显示的输出，解释如何<code>systemd-resolved</code>管理文件。如果您有一个不同的 IP 地址，<code>127.0.0.53</code>那么您的系统可能没有使用<code>systemd-resolved</code>，您可以转至下一节配置具有<code>update-resolv-conf</code>脚本的Linux 客户端。</p>
<p>要支持这些客户端，请首先安装该<code>openvpn-systemd-resolved</code>软件包。它提供了强制<code>systemd-resolved</code>使用 VPN 服务器进行 DNS 解析的脚本。</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback>sudo apt install openvpn-systemd-resolved
</code></pre></td></tr></table>
</div>
</div><p>安装该软件包之一，配置客户端以使用它，并通过 VPN 接口发送所有 DNS 查询。打开客户端的 VPN 文件：</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-bash data-lang=bash>nano client1.ovpn
</code></pre></td></tr></table>
</div>
</div><p>现在取消注释您之前添加的以下几行：</p>
<p>client1.ovpn</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback>script-security 2
up /etc/openvpn/update-systemd-resolved
down /etc/openvpn/update-systemd-resolved
down-pre
dhcp-option DOMAIN-ROUTE .
</code></pre></td></tr></table>
</div>
</div><h4 id=配置使用的客户端-update-resolv-conf>配置使用的客户端 <code>update-resolv-conf</code></h4>
<p>如果您的系统不<code>systemd-resolved</code>用于管理 DNS，请检查您的发行版是否包含<code>/etc/openvpn/update-resolv-conf</code>脚本：</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback>ls /etc/openvpn
</code></pre></td></tr></table>
</div>
</div><div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback>Output
update-resolv-conf
</code></pre></td></tr></table>
</div>
</div><p>如果您的客户端包含该<code>update-resolv-conf</code>文件，请编辑您之前传输的 OpenVPN 客户端配置文件：</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-bash data-lang=bash>nano client1.ovpn
</code></pre></td></tr></table>
</div>
</div><p>取消注释您添加的用于调整 DNS 设置的三行：</p>
<p>client1.ovpn</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback>script-security 2
up /etc/openvpn/update-resolv-conf
down /etc/openvpn/update-resolv-conf
</code></pre></td></tr></table>
</div>
</div><p>如果您使用 CentOS，请将<code>group</code>指令从<code>nogroup</code>to更改<code>nobody</code>为匹配发行版的可用组：</p>
<p>client1.ovpn</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback>group nobody
</code></pre></td></tr></table>
</div>
</div><p>保存并关闭文件。</p>
<p><strong>连接</strong></p>
<p>现在，您只需将<code>openvpn</code>命令指向客户端配置文件即可连接到 VPN ：</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback># 启动前注意检查 client1.ovpn 的 62 行。在 Ubuntu 系统上是 group nogroup，在 CentOS 系统上是 group nobody
sudo openvpn --config client1.ovpn
</code></pre></td></tr></table>
</div>
</div><p>这应该将您连接到您的 VPN。</p>
<p>**注意：**如果您的客户端用于<code>systemd-resolved</code>管理 DNS，请通过运行如下<code>systemd-resolve --status</code>命令检查设置是否正确应用：</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback>systemd-resolve --status tun0
</code></pre></td></tr></table>
</div>
</div><div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback>Output
Link 22 (tun0)
. . .
         DNS Servers: 208.67.222.222
                      208.67.220.220
          DNS Domain: ~.
</code></pre></td></tr></table>
</div>
</div><p>如果您看到您在 OpenVPN 服务器上配置的 DNS 服务器的 IP 地址，以及输出中<em>DNS 域</em>的<code>~.</code>设置，那么您已正确配置您的客户端以使用 VPN 服务器的 DNS 解析器。</p>
<h2 id=撤销客户端证书>撤销客户端证书</h2>
<p>有时，您可能需要撤销客户端证书以防止进一步访问 OpenVPN 服务器。</p>
<h3 id=ca-服务器-3>CA 服务器</h3>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback>cd ~/easy-rsa
./easyrsa revoke client1
</code></pre></td></tr></table>
</div>
</div><p>这将要求您通过输入 yes 来确认撤销:</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback>Output
Please confirm you wish to revoke the certificate with the following subject:

subject=
    commonName                = client-ccx


Type the word &#39;yes&#39; to continue, or any other input to abort.
  Continue with revocation: yes
Using configuration from /home/sammy/easy-rsa/pki/safessl-easyrsa.cnf
Revoking Certificate D3060496FB55BF756C970DF564AA4C17.
Data Base Updated

IMPORTANT!!!

Revocation was successful. You must run gen-crl and upload a CRL to your
infrastructure in order to prevent the revoked cert from being accepted.
</code></pre></td></tr></table>
</div>
</div><p>注意撤销证书行上突出显示的值。此值是要撤销的证书的唯一序列号。如果要检查本节最后一步中的撤销列表以验证证书是否在其中，则需要此值。</p>
<p>在确认操作之后，CA 将撤销证书。但是，依赖 CA 的远程系统无法检查是否有任何证书被撤销。用户和服务器仍然可以使用该证书，直至该证书的证书吊销列表(CRL)分发给所有依赖该证书的系统为止。</p>
<p><strong>生成一个证书吊销列表</strong></p>
<p>在 ~/easy-rsa 目录中使用 gen-CRL 选项运行 easy-rsa 命令:</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback>cd ~/easy-rsa
./easyrsa gen-crl
</code></pre></td></tr></table>
</div>
</div><p>发送证书吊销列表</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback># scp ~/easy-rsa/pki/crl.pem sammy@your_server_ip:/tmp
scp ~/easy-rsa/pki/crl.pem sammy@123.125.32.26:/tmp
</code></pre></td></tr></table>
</div>
</div><h3 id=openvpn-服务器-13>OpenVPN 服务器</h3>
<p>使用这些说明撤销客户端证书后，您需要将生成的 crl.pem 文件复制到 /etc/openvpn/server 目录中的 OpenVPN 服务器：</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback>sudo cp /tmp/crl.pem /etc/openvpn/server/
</code></pre></td></tr></table>
</div>
</div><p>接下来，打开 OpenVPN 服务器配置文件:</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback>sudo nano /etc/openvpn/server/server.conf
</code></pre></td></tr></table>
</div>
</div><p>在文件底部，添加 crl-verify 选项，该选项将指示 OpenVPN 服务器在每次尝试连接时检查您创建的证书吊销列表：</p>
<p>/etc/openvpn/server/server.conf</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback>crl-verify crl.pem
</code></pre></td></tr></table>
</div>
</div><p>保存并关闭文件。
最后，重新启动 OpenVPN 以实现证书撤销:</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback>sudo systemctl restart openvpn-server@server.service
</code></pre></td></tr></table>
</div>
</div><p>客户端应该不再能够使用旧凭据成功连接到服务器。
要撤销其他客户端，请按照以下流程操作：</p>
<ol>
<li>使用 ./easyrsa revoke client_name 命令撤销证书</li>
<li>生成新的 CRL</li>
<li>将新的 crl.pem 文件传输到您的 OpenVPN 服务器并将其复制到 /etc/openvpn/server/ 目录以覆盖旧列表。</li>
<li>重新启动 OpenVPN 服务。</li>
</ol>
<p>您可以使用此过程撤销您之前为服务器颁发的任何证书。</p>
<h2 id=配置更多客户端>配置更多客户端</h2>
<p><strong>修改 client1 为你要的客户端名称</strong></p>
<h3 id=openvpn-服务器-14>OpenVPN 服务器</h3>
<p>到 EasyRSA 目录并 easyrsa 使用gen-req 和 nopass 选项以及客户端的通用名称运行脚本：</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback>cd ~/easy-rsa
./easyrsa gen-req client1 nopass
</code></pre></td></tr></table>
</div>
</div><p>按 ENTER 确认常用名称。然后，将 client1.key 文件复制到 ~/client-configs/keys/ 您之前创建的目录中：</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback>cp pki/private/client1.key ~/client-configs/keys/
</code></pre></td></tr></table>
</div>
</div><h3 id=ca-服务器-4>CA 服务器</h3>
<p>现在登录到您的 CA 服务器。</p>
<p>接下来，将 client1.req 使用安全方法将文件传输到您的 CA 服务器：</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback># scp sammy@your_openvpn_server_ip:/home/sammy/easy-rsa/pki/reqs/client1.req /tmp
scp sammy@123.125.32.26:/home/sammy/easy-rsa/pki/reqs/client1.req /tmp
</code></pre></td></tr></table>
</div>
</div><p>然后，导航到 EasyRSA 目录，并导入证书请求：</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback>cd ~/easy-rsa
./easyrsa import-req /tmp/client1.req client1
./easyrsa sign-req client client1
</code></pre></td></tr></table>
</div>
</div><p>出现提示时，输入 ye s以确认您打算签署证书请求并且它来自受信任的来源：</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback>Output
Note: using Easy-RSA configuration from: ./vars

Using SSL: openssl OpenSSL 1.1.1f  31 Mar 2020


You are about to sign the following certificate.
Please check over the details shown below for accuracy. Note that this request
has not been cryptographically verified. Please be sure it came from a trusted
source or that you have verified the request checksum with the sender.

Request subject, to be signed as a client certificate for 1080 days:

subject=
    commonName                = client1


Type the word &#39;yes&#39; to continue, or any other input to abort.
  Confirm request details: yes
Using configuration from /home/sammy/easy-rsa/pki/safessl-easyrsa.cnf
Check that the request matches the signature
Signature ok
The Subject&#39;s Distinguished Name is as follows
commonName            :ASN.1 12:&#39;client1&#39;
Certificate is to be certified until Jul  6 06:18:09 2025 GMT (1080 days)

Write out database with 1 new entries
Data Base Updated

Certificate created at: /home/sammy/easy-rsa/pki/issued/client1.crt
</code></pre></td></tr></table>
</div>
</div><p>这将创建一个名为 client1.crt 将此文件传输回服务器：</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback># scp pki/issued/client1.crt sammy@your_server_ip:/tmp
scp pki/issued/client1.crt sammy@123.125.32.26:/tmp
</code></pre></td></tr></table>
</div>
</div><h3 id=openvpn-服务器-15>OpenVPN 服务器</h3>
<p>回到您的 OpenVPN 服务器，将客户端证书复制到~/client-configs/keys/目录：</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback>cp /tmp/client1.crt ~/client-configs/keys/
</code></pre></td></tr></table>
</div>
</div><p>生成配置文件：</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback>cd ~/client-configs
./make_config.sh client1
</code></pre></td></tr></table>
</div>
</div><p>这将<code>client1.ovpn</code>在您的<code>~/client-configs/files</code>目录中创建一个名为的文件：</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-bash data-lang=bash>ls ~/client-configs/files
</code></pre></td></tr></table>
</div>
</div><div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback>Output
client1.ovpn
</code></pre></td></tr></table>
</div>
</div><p>您需要将此文件传输到您计划用作客户端的设备。例如，这可能是您的本地计算机或移动设备。</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback># sftp sammy@openvpn_server_ip:client-configs/files/client1.ovpn ~/
sftp sammy@123.125.32.26:client-configs/files/client1.ovpn ~/
</code></pre></td></tr></table>
</div>
</div><h3 id=安装客户端配置-1>安装客户端配置</h3>
<p><strong>离线安装</strong></p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback># ubuntu20.04 系统
sudo dpkg -i pkg/ubuntu20.04/openvpn_2.4.7-1ubuntu2.20.04.4_amd64.deb
</code></pre></td></tr></table>
</div>
</div><div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback># redhat8.6 系统
sudo rpm -i pkg/redhat8.6/pkg/*
</code></pre></td></tr></table>
</div>
</div><p><strong>在线安装</strong></p>
<p>如果您使用的是 Linux，则可以根据您的发行版使用多种工具。您的桌面环境或窗口管理器可能还包括连接实用程序。</p>
<p>然而，最通用的连接方式是使用 OpenVPN 软件。</p>
<p>在 Ubuntu 或 Debian 上，您可以像在服务器上一样通过键入以下内容来安装它：</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback>sudo apt update
sudo apt install openvpn
</code></pre></td></tr></table>
</div>
</div><p>在 CentOS 上，您可以启用 EPEL 存储库，然后键入以下内容进行安装：</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-bash data-lang=bash>sudo dnf install epel-release
sudo dnf install openvpn
</code></pre></td></tr></table>
</div>
</div><h4 id=配置使用的客户端-systemd-resolved-1>配置使用的客户端 <code>systemd-resolved</code></h4>
<p>首先<code>systemd-resolved</code>通过检查<code>/etc/resolv.conf</code>文件来确定您的系统是否用于处理 DNS 解析：</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback>cat /etc/resolv.conf
</code></pre></td></tr></table>
</div>
</div><div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback>Output
# This file is managed by man:systemd-resolved(8). Do not edit.
. . .

nameserver 127.0.0.53
options edns0
</code></pre></td></tr></table>
</div>
</div><p>如果您的系统配置为<code>systemd-resolved</code>用于 DNS 解析，则<code>nameserver</code>选项后面的 IP 地址将为<code>127.0.0.53</code>. 文件中还应该有注释，如显示的输出，解释如何<code>systemd-resolved</code>管理文件。如果您有一个不同的 IP 地址，<code>127.0.0.53</code>那么您的系统可能没有使用<code>systemd-resolved</code>，您可以转至下一节配置具有<code>update-resolv-conf</code>脚本的Linux 客户端。</p>
<p>要支持这些客户端，请首先安装该<code>openvpn-systemd-resolved</code>软件包。它提供了强制<code>systemd-resolved</code>使用 VPN 服务器进行 DNS 解析的脚本。</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback>sudo apt install openvpn-systemd-resolved
</code></pre></td></tr></table>
</div>
</div><p>安装该软件包之一，配置客户端以使用它，并通过 VPN 接口发送所有 DNS 查询。打开客户端的 VPN 文件：</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-bash data-lang=bash>nano client1.ovpn
</code></pre></td></tr></table>
</div>
</div><p>现在取消注释您之前添加的以下几行：</p>
<p>client1.ovpn</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback>script-security 2
up /etc/openvpn/update-systemd-resolved
down /etc/openvpn/update-systemd-resolved
down-pre
dhcp-option DOMAIN-ROUTE .
</code></pre></td></tr></table>
</div>
</div><h4 id=配置使用的客户端-update-resolv-conf-1>配置使用的客户端 <code>update-resolv-conf</code></h4>
<p>如果您的系统不<code>systemd-resolved</code>用于管理 DNS，请检查您的发行版是否包含<code>/etc/openvpn/update-resolv-conf</code>脚本：</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback>ls /etc/openvpn
</code></pre></td></tr></table>
</div>
</div><div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback>Output
update-resolv-conf
</code></pre></td></tr></table>
</div>
</div><p>如果您的客户端包含该<code>update-resolv-conf</code>文件，请编辑您之前传输的 OpenVPN 客户端配置文件：</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-bash data-lang=bash>nano client1.ovpn
</code></pre></td></tr></table>
</div>
</div><p>取消注释您添加的用于调整 DNS 设置的三行：</p>
<p>client1.ovpn</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback>script-security 2
up /etc/openvpn/update-resolv-conf
down /etc/openvpn/update-resolv-conf
</code></pre></td></tr></table>
</div>
</div><p>如果您使用 CentOS，请将<code>group</code>指令从<code>nogroup</code>to更改<code>nobody</code>为匹配发行版的可用组：</p>
<p>client1.ovpn</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback>group nobody
</code></pre></td></tr></table>
</div>
</div><p>保存并关闭文件。</p>
<p><strong>连接</strong></p>
<p>现在，您只需将<code>openvpn</code>命令指向客户端配置文件即可连接到 VPN ：</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback># 启动前注意检查 client1.ovpn 的 62 行。在 Ubuntu 系统上是 group nogroup，在 CentOS 系统上是 group nobody
sudo openvpn --config client1.ovpn
</code></pre></td></tr></table>
</div>
</div><p>这应该将您连接到您的 VPN。</p>
<p>**注意：**如果您的客户端用于<code>systemd-resolved</code>管理 DNS，请通过运行如下<code>systemd-resolve --status</code>命令检查设置是否正确应用：</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback>systemd-resolve --status tun0
</code></pre></td></tr></table>
</div>
</div><div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback>Output
Link 22 (tun0)
. . .
         DNS Servers: 208.67.222.222
                      208.67.220.220
          DNS Domain: ~.
</code></pre></td></tr></table>
</div>
</div><p>如果您看到您在 OpenVPN 服务器上配置的 DNS 服务器的 IP 地址，以及输出中<em>DNS 域</em>的<code>~.</code>设置，那么您已正确配置您的客户端以使用 VPN 服务器的 DNS 解析器。</p>
<h1 id=安装-openvpn-客户端配置>安装 OpenVPN 客户端配置</h1>
<p><strong>离线安装</strong></p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback>sudo rpm -i pkg/redhat8.6/pkg/*
</code></pre></td></tr></table>
</div>
</div><p>配置文件</p>
<ul>
<li>xxx-master.ovpn: 在 master 节点使用，会固定 VPN 的 IP，只能单节点使用。</li>
<li>xxx-worker.ovpn: 在 worker 节点使用，不会固定 VPN 的 IP，可以多节点使用。</li>
</ul>
<p><strong>配置使用</strong></p>
<blockquote>
<p>如果客户端需要固定端口的情况才操作，一般情况忽略。固定客户端端口：修改 xxx.ovpn 第 58 行，nobind -> port 51194</p>
</blockquote>
<p>设置 systemctl 管理</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback># 复制文件
sudo cp xxx.ovpn /etc/openvpn/client/client.conf
# 开机启动
systemctl enable openvpn-client@client
# 启动
systemctl start openvpn-client@client
# 停止
systemctl stop openvpn-client@client
</code></pre></td></tr></table>
</div>
</div><p>测试</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback>systemctl status openvpn-client@client
ping 10.10.0.1
</code></pre></td></tr></table>
</div>
</div><h1 id=其它设置>其它设置</h1>
<h2 id=客户端固定端口>客户端固定端口</h2>
<p>修改 client1.ovpn 第 58 行，nobind -> port 51194</p>
<h2 id=设置-systemctl-启动>设置 systemctl 启动</h2>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback>sudo cp client1.ovpn /etc/openvpn/client/client.conf
# 开机启动
systemctl enable openvpn-client@client
# 启动
systemctl start openvpn-client@client
# 停止
systemctl stop openvpn-client@client

# 测试
systemctl status openvpn-client@client
ping 10.8.0.1
</code></pre></td></tr></table>
</div>
</div><h2 id=固定客户端-ip>固定客户端 IP</h2>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback># openvpn 服务器
vi /etc/openvpn/server/server.conf
# 添加一行
client-config-dir /etc/openvpn/ccd
</code></pre></td></tr></table>
</div>
</div><p>在 /etc/openvpn/ccd 创建文件，文件名为客户端的 CN 名称，内容为<code>ifconfig-push ${IP} ${NETMASK}</code></p>
<p>样例：</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback>sammy@OpenVPN:/etc/openvpn/ccd$ ll
total 12
drwxr-xr-x 2 root root 4096 Aug 22 15:50 ./
drwxr-xr-x 5 root root 4096 Aug 22 15:19 ../
-rw-r--r-- 1 root root   35 Aug 22 15:50 tx-cjx-master
sammy@OpenVPN:/etc/openvpn/ccd$ cat tx-cjx-master 
ifconfig-push 10.8.0.100 10.8.0.99
</code></pre></td></tr></table>
</div>
</div><h3 id=效果>效果</h3>
<p>在开启了允许客户端证书复用的情况下。固定了 IP 的证书被重复使用时，只有最后一个使用者可以连接到服务器，IP 固定。
未固定 IP 的证书可以正常复用。</p>
<h1 id=安装-openvpn-客户端配置-1>安装 OpenVPN 客户端配置</h1>
<p><strong>离线安装</strong></p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback>sudo rpm -i pkg/redhat8.6/pkg/*
</code></pre></td></tr></table>
</div>
</div><p>配置文件</p>
<ul>
<li>xxx-master.ovpn: 在 master 节点使用，会固定 VPN 的 IP，只能单节点使用。</li>
<li>xxx-worker.ovpn: 在 worker 节点使用，不会固定 VPN 的 IP，可以多节点使用。</li>
</ul>
<p><strong>配置使用</strong></p>
<blockquote>
<p>如果客户端需要固定端口的情况才操作，一般情况忽略。固定客户端端口：修改 xxx.ovpn 第 58 行，nobind -> port 51194</p>
</blockquote>
<p>设置 systemctl 管理</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback># 复制文件
sudo cp xxx.ovpn /etc/openvpn/client/client.conf
# 开机启动
systemctl enable openvpn-client@client
# 启动
systemctl start openvpn-client@client
# 停止
systemctl stop openvpn-client@client
</code></pre></td></tr></table>
</div>
</div><p>测试</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback>systemctl status openvpn-client@client
ping 10.10.0.1
</code></pre></td></tr></table>
</div>
</div>
</section>
<footer class=article-footer>
<section class=article-tags>
<a href=/blog/tags/%E7%BD%91%E7%BB%9C/>网络</a>
<a href=/blog/tags/openvpn/>openVPN</a>
</section>
<section class=article-copyright><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg>
<span>Licensed under CC BY-NC-SA 4.0</span>
</section>
</footer>
</article>
<aside class=related-content--wrapper>
<h2 class=section-title>相关文章</h2>
<div class=related-content>
<div class="flex article-list--tile">
<article>
<a href=/blog/p/%E7%BD%91%E7%BB%9C%E5%AD%A6%E4%B9%A0-0001/>
<div class=article-details>
<h2 class=article-title>网络学习-0001</h2>
</div>
</a>
</article>
<article>
<a href=/blog/p/%E7%BD%91%E7%BB%9C%E5%AD%A6%E4%B9%A0-0001/>
<div class=article-details>
<h2 class=article-title>网络学习-0001</h2>
</div>
</a>
</article>
<article>
<a href=/blog/p/%E7%BD%91%E7%BB%9C%E9%97%AE%E9%A2%98/>
<div class=article-details>
<h2 class=article-title>网络问题</h2>
</div>
</a>
</article>
<article>
<a href=/blog/p/iptables/>
<div class=article-details>
<h2 class=article-title>iptables</h2>
</div>
</a>
</article>
<article>
<a href=/blog/p/ip-netns-ling/>
<div class=article-details>
<h2 class=article-title>ip-netns-ling</h2>
</div>
</a>
</article>
</div>
</div>
</aside>
<div class=disqus-container>
<div id=disqus_thread></div>
<script type=application/javascript>var disqus_config=function(){};(function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById('disqus_thread').innerHTML='Disqus comments not available by default when the website is previewed locally.';return}var b=document,a=b.createElement('script');a.async=!0,a.src='//hugo-theme-stack.disqus.com/embed.js',a.setAttribute('data-timestamp',+new Date),(b.head||b.body).appendChild(a)})()</script>
<noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript>
<a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a>
</div>
<style>.disqus-container{background-color:var(--card-background);border-radius:var(--card-border-radius);box-shadow:var(--shadow-l1);padding:var(--card-padding)}</style>
<script>window.addEventListener('onColorSchemeChange',a=>{typeof DISQUS=='object'&&DISQUS.reset({reload:!0})})</script>
<footer class=site-footer>
<section class=copyright>
&copy;
2020 -
2022 我的空间
</section>
<section class=powerby>
Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a> <br>
主题 <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.13.0>Stack</a></b> 由 <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a> 设计
<br><a href=https://beian.miit.gov.cn/ target=_blank>粤ICP备19123935号</a>
</section>
</footer>
<div class=pswp tabindex=-1 role=dialog aria-hidden=true>
<div class=pswp__bg></div>
<div class=pswp__scroll-wrap>
<div class=pswp__container>
<div class=pswp__item></div>
<div class=pswp__item></div>
<div class=pswp__item></div>
</div>
<div class="pswp__ui pswp__ui--hidden">
<div class=pswp__top-bar>
<div class=pswp__counter></div>
<button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
<div class=pswp__preloader>
<div class=pswp__preloader__icn>
<div class=pswp__preloader__cut>
<div class=pswp__preloader__donut></div>
</div>
</div>
</div>
</div>
<div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
<div class=pswp__share-tooltip></div>
</div>
<button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
</button>
<div class=pswp__caption>
<div class=pswp__caption__center></div>
</div>
</div>
</div>
</div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous>
</main>
<aside class="sidebar right-sidebar sticky">
<section class="widget archives">
<div class=widget-icon><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg>
</div>
<h2 class="widget-title section-title">目录</h2>
<div class=widget--toc>
<nav id=TableOfContents>
<ol>
<li><a href=#初始服务器设置>初始服务器设置</a>
<ol>
<li><a href=#openvpn-服务器>OpenVPN 服务器</a>
<ol>
<li><a href=#创建新用户>创建新用户</a></li>
</ol>
</li>
<li><a href=#ca-服务器>CA 服务器</a>
<ol>
<li><a href=#创建新用户-1>创建新用户</a></li>
<li><a href=#安装-easy-rsa>安装 Easy-RSA</a></li>
<li><a href=#创建公开密码匙基础建设目录>创建公开密码匙基础建设目录</a></li>
<li><a href=#创建证书颁发机构>创建证书颁发机构</a></li>
</ol>
</li>
</ol>
</li>
<li><a href=#安装-openvpn-和-easy-rsa>安装 OpenVPN 和 Easy-RSA</a>
<ol>
<li><a href=#openvpn-服务器-1>OpenVPN 服务器</a></li>
</ol>
</li>
<li><a href=#为-openvpn-创建-pki>为 OpenVPN 创建 PKI</a>
<ol>
<li><a href=#openvpn-服务器-2>OpenVPN 服务器</a></li>
</ol>
</li>
<li><a href=#创建-openvpn-服务器证书请求和私钥>创建 OpenVPN 服务器证书请求和私钥</a>
<ol>
<li><a href=#openvpn-服务器-3>OpenVPN 服务器</a></li>
</ol>
</li>
<li><a href=#签署-openvpn-服务器的证书请求>签署 OpenVPN 服务器的证书请求</a>
<ol>
<li><a href=#ca-服务器-1>CA 服务器</a></li>
<li><a href=#openvpn-服务器-4>OpenVPN 服务器</a></li>
</ol>
</li>
<li><a href=#配置-openvpn-加密材料>配置 OpenVPN 加密材料</a>
<ol>
<li><a href=#openvpn-服务器-5>OpenVPN 服务器</a></li>
</ol>
</li>
<li><a href=#生成客户端证书和密钥对>生成客户端证书和密钥对</a>
<ol>
<li><a href=#openvpn-服务器-6>OpenVPN 服务器</a></li>
<li><a href=#ca-服务器-2>CA 服务器</a></li>
<li><a href=#openvpn-服务器-7>OpenVPN 服务器</a></li>
</ol>
</li>
<li><a href=#配置-openvpn>配置 OpenVPN</a>
<ol>
<li><a href=#openvpn-服务器-8>OpenVPN 服务器</a></li>
</ol>
</li>
<li><a href=#调整-openvpn-服务器网络配置>调整 OpenVPN 服务器网络配置</a>
<ol>
<li><a href=#openvpn-服务器-9>OpenVPN 服务器</a></li>
</ol>
</li>
<li><a href=#防火墙配置未开启防火墙可以跳过>防火墙配置(未开启防火墙可以跳过)</a>
<ol>
<li><a href=#openvpn-服务器-10>OpenVPN 服务器</a></li>
</ol>
</li>
<li><a href=#启动-openvpn>启动 OpenVPN</a>
<ol>
<li><a href=#openvpn-服务器-11>OpenVPN 服务器</a></li>
</ol>
</li>
<li><a href=#创建客户端配置基础架构无特殊需求可以跳过>创建客户端配置基础架构(无特殊需求可以跳过)</a>
<ol>
<li><a href=#openvpn-服务器-12>OpenVPN 服务器</a></li>
</ol>
</li>
<li><a href=#生成客户端配置>生成客户端配置</a></li>
<li><a href=#安装客户端配置>安装客户端配置</a>
<ol>
<li>
<ol>
<li><a href=#配置使用的客户端-systemd-resolved>配置使用的客户端 <code>systemd-resolved</code></a></li>
<li><a href=#配置使用的客户端-update-resolv-conf>配置使用的客户端 <code>update-resolv-conf</code></a></li>
</ol>
</li>
</ol>
</li>
<li><a href=#撤销客户端证书>撤销客户端证书</a>
<ol>
<li><a href=#ca-服务器-3>CA 服务器</a></li>
<li><a href=#openvpn-服务器-13>OpenVPN 服务器</a></li>
</ol>
</li>
<li><a href=#配置更多客户端>配置更多客户端</a>
<ol>
<li><a href=#openvpn-服务器-14>OpenVPN 服务器</a></li>
<li><a href=#ca-服务器-4>CA 服务器</a></li>
<li><a href=#openvpn-服务器-15>OpenVPN 服务器</a></li>
<li><a href=#安装客户端配置-1>安装客户端配置</a>
<ol>
<li><a href=#配置使用的客户端-systemd-resolved-1>配置使用的客户端 <code>systemd-resolved</code></a></li>
<li><a href=#配置使用的客户端-update-resolv-conf-1>配置使用的客户端 <code>update-resolv-conf</code></a></li>
</ol>
</li>
</ol>
</li>
</ol>
<ol>
<li><a href=#客户端固定端口>客户端固定端口</a></li>
<li><a href=#设置-systemctl-启动>设置 systemctl 启动</a></li>
<li><a href=#固定客户端-ip>固定客户端 IP</a>
<ol>
<li><a href=#效果>效果</a></li>
</ol>
</li>
</ol>
</nav>
</div>
</section>
</aside>
</div>
<script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/blog/ts/main.js defer></script>
<script>(function(){const a=document.createElement('link');a.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",a.type="text/css",a.rel="stylesheet",document.head.appendChild(a)})()</script>
</body>
</html>