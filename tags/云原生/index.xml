<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>云原生 on 我的空间</title><link>https://mkbooks.github.io/blog/tags/%E4%BA%91%E5%8E%9F%E7%94%9F/</link><description>Recent content in 云原生 on 我的空间</description><generator>Hugo -- gohugo.io</generator><language>en-us</language><lastBuildDate>Thu, 18 Jul 2024 23:01:00 +0800</lastBuildDate><atom:link href="https://mkbooks.github.io/blog/tags/%E4%BA%91%E5%8E%9F%E7%94%9F/index.xml" rel="self" type="application/rss+xml"/><item><title>kubernetes</title><link>https://mkbooks.github.io/blog/p/kubernetes/</link><pubDate>Thu, 18 Jul 2024 23:01:00 +0800</pubDate><guid>https://mkbooks.github.io/blog/p/kubernetes/</guid><description>&lt;h2 id="云原生">云原生&lt;/h2>
&lt;p>云：抽象的计算资源（计算资源池: 公有云、私有云、混合云）&lt;/p>
&lt;p>云原生的基本思想：
0. 基础架构即代码，GitOps: 云原生中管理的一切对象都用git的方式以源代码的形式管理起来，做到绝对的可追溯。&lt;/p>
&lt;ol>
&lt;li>动态环境（云资源一体，不关心是哪来的资源）&lt;/li>
&lt;li>自动化（声明式API，最终一致性）&lt;/li>
&lt;li>DevOps
&lt;ol>
&lt;li>CI/CD（流水线对接云服务）&lt;/li>
&lt;/ol>
&lt;/li>
&lt;li>&amp;hellip;&amp;hellip;&lt;/li>
&lt;/ol>
&lt;h2 id="kubernetes">kubernetes&lt;/h2>
&lt;blockquote>
&lt;p>云生态的核心组件&lt;/p>
&lt;/blockquote>
&lt;p>Kubernetes（简称K8s）是一个开源的&lt;strong>容器编排&lt;/strong>平台，用于自动化部署、扩展和管理容器化应用程序。&lt;/p>
&lt;h3 id="容器技术">容器技术&lt;/h3>
&lt;ol>
&lt;li>Namespace: 进程隔离
&lt;ol>
&lt;li>PID（Process ID）命名空间：隔离进程ID，每个容器可以有自己的进程编号。&lt;/li>
&lt;li>网络（Network）命名空间：隔离网络接口，容器内的应用看到的只是容器内的网络环境。&lt;/li>
&lt;li>挂载（Mount）命名空间：隔离文件系统挂载点，每个容器可以有自己的文件系统布局。&lt;/li>
&lt;li>IPC（Inter-Process Communication）命名空间：隔离进程间通信资源，例如信号量和消息队列。&lt;/li>
&lt;li>UTS（Unix Timesharing System）命名空间：隔离主机名和域名，容器可以有自己的主机名。&lt;/li>
&lt;li>用户（User）命名空间：隔离用户ID和组ID，容器内的root可以与宿主机的root有不同的权限。&lt;/li>
&lt;/ol>
&lt;/li>
&lt;li>Cgroup：资源管控
&lt;ol>
&lt;li>CPU&lt;/li>
&lt;li>内存&lt;/li>
&lt;li>硬盘 I/O&lt;/li>
&lt;/ol>
&lt;/li>
&lt;li>UnionFS：文件系统服务&lt;/li>
&lt;/ol>
&lt;h3 id="容器技术解决了哪些问题">容器技术解决了哪些问题&lt;/h3>
&lt;h4 id="1-环境一致性问题">1. 环境一致性问题&lt;/h4>
&lt;p>容器确保了从开发到测试再到生产的环境一致性。这解决了“在我的机器上运行正常”这类问题，因为容器为应用程序提供了一个隔离的、一致的运行环境，包括相同的软件、配置和依赖。&lt;/p>
&lt;h4 id="2-配置管理问题">2. 配置管理问题&lt;/h4>
&lt;p>容器通过将应用程序及其全部依赖打包在一起，简化了配置管理。这意味着开发者不需要在每个环境中重新配置应用程序，可以避免因配置差异导致的错误。&lt;/p>
&lt;h4 id="3-兼容性和依赖问题">3. 兼容性和依赖问题&lt;/h4>
&lt;p>通过使用容器，开发者可以打包应用程序所需的库、工具和运行时环境，避免了软件在不同系统环境下运行时可能遇到的兼容性和依赖问题。&lt;/p>
&lt;h4 id="4-快速部署和扩展">4. 快速部署和扩展&lt;/h4>
&lt;p>容器的轻量级特性使得启动速度非常快，几乎可以实现秒级部署。这对于需要快速扩展的服务尤其重要。容器还支持自动化的部署和扩展，使得管理大规模应用程序变得更加容易。&lt;/p>
&lt;h4 id="5-资源利用和隔离">5. 资源利用和隔离&lt;/h4>
&lt;p>容器在操作系统级别进行资源隔离，使得每个容器都运行在指定的资源限制之内，而不会干扰其他容器。同时，容器共享同一个操作系统核心，与传统的虚拟机相比，能更有效地利用物理资源。&lt;/p>
&lt;h4 id="6-移植性问题">6. 移植性问题&lt;/h4>
&lt;p>容器技术提高了应用程序的移植性。由于容器在任何支持容器运行时的系统上都能运行，这使得从一个环境迁移到另一个环境（如从物理机到云平台）变得简单和可靠。&lt;/p>
&lt;h4 id="7-持续集成和持续交付cicd">7. 持续集成和持续交付（CI/CD）&lt;/h4>
&lt;p>容器非常适合实现自动化的持续集成和持续交付流程。开发者可以快速构建和回滚应用程序版本，实现高频率的更新和部署，而不影响系统的稳定性。&lt;/p>
&lt;h4 id="8-降低开发与运维devops的障碍">8. 降低开发与运维（DevOps）的障碍&lt;/h4>
&lt;p>容器化鼓励采用微服务架构，每个服务可以独立开发、部署和扩展。这降低了团队间的协调复杂性，加速了开发流程，使开发和运维更加紧密地合作。&lt;/p>
&lt;p>&lt;img src="https://mkbooks.github.io/k8s-001/2/1/images/%E8%99%9A%E6%8B%9F%E6%9C%BA%E5%92%8C%E5%AE%B9%E5%99%A8%E8%BF%90%E8%A1%8C%E6%80%81%E7%9A%84%E5%AF%B9%E6%AF%94-%E8%99%9A%E6%8B%9F%E6%9C%BA.png"
loading="lazy"
alt="虚拟机和容器运行态的对比"
>&lt;/p>
&lt;p>&lt;img src="https://mkbooks.github.io/k8s-001/2/1/images/%E8%99%9A%E6%8B%9F%E6%9C%BA%E5%92%8C%E5%AE%B9%E5%99%A8%E8%BF%90%E8%A1%8C%E6%80%81%E7%9A%84%E5%AF%B9%E6%AF%94-%E5%AE%B9%E5%99%A8.png"
loading="lazy"
alt="虚拟机和容器运行态的对比"
>&lt;/p>
&lt;h2 id="docker">docker&lt;/h2>
&lt;h3 id="安装">安装&lt;/h3>
&lt;p>在 ubuntu 上安装 Docker 运行时，参考 &lt;a class="link" href="https://docs.docker.com/engine/install/ubuntu/" target="_blank" rel="noopener"
>https://docs.docker.com/engine/install/ubuntu/&lt;/a>&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">$ sudo apt-get update
$ sudo apt-get install \
apt-transport-https \
ca-certificates \
curl \
gnupg-agent \
software-properties-common
$ curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add -
$ sudo add-apt-repository \
&amp;#34;deb [arch=amd64] https://download.docker.com/linux/ubuntu \
$(lsb_release -cs) \
stable&amp;#34;
$ sudo apt-get update
$ sudo apt-get install docker-ce docker-ce-cli containerd.io
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="操作">操作&lt;/h3>
&lt;p>启动：&lt;/p>
&lt;ul>
&lt;li>docker run
&lt;ul>
&lt;li>-it 交互&lt;/li>
&lt;li>-d 后台运行&lt;/li>
&lt;li>-p 端口映射&lt;/li>
&lt;li>-v 磁盘挂载&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>启动已终止容器
&lt;ul>
&lt;li>docker start&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>停止容器
&lt;ul>
&lt;li>docker stop&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>查看容器进程
&lt;ul>
&lt;li>docker ps&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>查看容器细节：
&lt;ul>
&lt;li>docker inspect &amp;lt;containerid&amp;gt;&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>进入容器；
&lt;ul>
&lt;li>docker exec -it &amp;lt;containerid&amp;gt; bash&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>Docker attach：
&lt;ul>
&lt;li>通过 nsenter&lt;/li>
&lt;li>PID=$(docker inspect &amp;ndash;format &amp;ldquo;{{ .State.Pid }}&amp;rdquo; &amp;lt;container&amp;gt;)&lt;/li>
&lt;li>$ nsenter &amp;ndash;target $PID &amp;ndash;mount &amp;ndash;uts &amp;ndash;ipc &amp;ndash;net &amp;ndash;pid&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>拷贝文件至容器内：
&lt;ul>
&lt;li>docker cp file1 &amp;lt;containerid&amp;gt;:/file-to-path&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;h3 id="demo">Demo&lt;/h3>
&lt;p>代码: main.go&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;span class="lnt">33
&lt;/span>&lt;span class="lnt">34
&lt;/span>&lt;span class="lnt">35
&lt;/span>&lt;span class="lnt">36
&lt;/span>&lt;span class="lnt">37
&lt;/span>&lt;span class="lnt">38
&lt;/span>&lt;span class="lnt">39
&lt;/span>&lt;span class="lnt">40
&lt;/span>&lt;span class="lnt">41
&lt;/span>&lt;span class="lnt">42
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="kn">package&lt;/span> &lt;span class="nx">main&lt;/span>
&lt;span class="kn">import&lt;/span> &lt;span class="p">(&lt;/span>
&lt;span class="s">&amp;#34;fmt&amp;#34;&lt;/span>
&lt;span class="s">&amp;#34;os&amp;#34;&lt;/span>
&lt;span class="s">&amp;#34;github.com/gin-gonic/gin&amp;#34;&lt;/span>
&lt;span class="s">&amp;#34;github.com/thinkeridea/go-extend/exnet&amp;#34;&lt;/span>
&lt;span class="p">)&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="nf">main&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">r&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">gin&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Default&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="nx">r&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">GET&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;/healthz&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">healthHandler&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="c1">// listen and serve on 0.0.0.0:8080
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">r&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Run&lt;/span>&lt;span class="p">();&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nb">panic&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">err&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="c1">// healthHandler healthcheck实现, curl -v localhost:8080/healthz -H &amp;#34;ttt:yyy&amp;#34;
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="kd">func&lt;/span> &lt;span class="nf">healthHandler&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">c&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">gin&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Context&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">// 遍历request的header并循环写入response header
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">for&lt;/span> &lt;span class="nx">k&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">v&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="k">range&lt;/span> &lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Request&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Header&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Writer&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Header&lt;/span>&lt;span class="p">().&lt;/span>&lt;span class="nf">Set&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">k&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">v&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">])&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="c1">// 获取环境变量VERSION并写入reponse header
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Writer&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Header&lt;/span>&lt;span class="p">().&lt;/span>&lt;span class="nf">Set&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;version&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">os&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Getenv&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;VERSION&amp;#34;&lt;/span>&lt;span class="p">))&lt;/span>
&lt;span class="c1">// 日志记录客户端ip, http返回码, 输出到标准输出
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">ip&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">exnet&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">ClientPublicIP&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Request&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">ip&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="s">&amp;#34;&amp;#34;&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">ip&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">exnet&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">ClientIP&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Request&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Printf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;客户端ip:%s, http返回码:%d\n&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">ip&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">200&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="c1">// 响应healthcheck信息, 状态码为200
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">JSON&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">200&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">gin&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">H&lt;/span>&lt;span class="p">{&lt;/span>
&lt;span class="s">&amp;#34;message&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s">&amp;#34;pong&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="p">})&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>Dockerfile1：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-Dockerfile" data-lang="Dockerfile">&lt;span class="k">FROM&lt;/span>&lt;span class="s"> golang:alpine&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">&lt;/span>&lt;span class="k">ENV&lt;/span> &lt;span class="nv">GO111MODULE&lt;/span>&lt;span class="o">=&lt;/span>on &lt;span class="se">\
&lt;/span>&lt;span class="se">&lt;/span> &lt;span class="nv">CGO_ENABLED&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">0&lt;/span> &lt;span class="se">\
&lt;/span>&lt;span class="se">&lt;/span> &lt;span class="nv">GOOS&lt;/span>&lt;span class="o">=&lt;/span>linux &lt;span class="se">\
&lt;/span>&lt;span class="se">&lt;/span> &lt;span class="nv">GOARCH&lt;/span>&lt;span class="o">=&lt;/span>amd64 &lt;span class="se">\
&lt;/span>&lt;span class="se">&lt;/span> &lt;span class="nv">GOPROXY&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;https://goproxy.cn,direct&amp;#34;&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">&lt;/span>&lt;span class="k">WORKDIR&lt;/span>&lt;span class="s"> /root/ccx&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">&lt;/span>&lt;span class="k">COPY&lt;/span> main.go .&lt;span class="err">
&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">&lt;/span>&lt;span class="k">RUN&lt;/span> go mod init example.com/httpserver&lt;span class="err">
&lt;/span>&lt;span class="err">&lt;/span>&lt;span class="k">RUN&lt;/span> go mod tidy&lt;span class="err">
&lt;/span>&lt;span class="err">&lt;/span>&lt;span class="k">RUN&lt;/span> go build -o httpserver .&lt;span class="err">
&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">&lt;/span>&lt;span class="k">WORKDIR&lt;/span>&lt;span class="s"> /opt/modules/httpserver&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">&lt;/span>&lt;span class="k">RUN&lt;/span> mkdir src .&lt;span class="err">
&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">&lt;/span>&lt;span class="k">RUN&lt;/span> cp /root/ccx/httpserver ./src&lt;span class="err">
&lt;/span>&lt;span class="err">&lt;/span>&lt;span class="k">EXPOSE&lt;/span>&lt;span class="s"> 8080&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">&lt;/span>&lt;span class="k">CMD&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="s2">&amp;#34;/opt/modules/httpserver/src/httpserver&amp;#34;&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="err">
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>测试运行：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">docker build -t ccx/httpserver:v0.0.1 .
docker run -d --name httpserver -p 9090:8080 -e &lt;span class="nv">VERSION&lt;/span>&lt;span class="o">=&lt;/span>v0.0.1 ccx/httpserver:v0.0.1
docker logs -f httpserver
curl -v localhost:9090/healthz -H &lt;span class="s2">&amp;#34;ttt:yyy&amp;#34;&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>构建优化：Dockerfile2：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-Dockerfile" data-lang="Dockerfile">&lt;span class="c"># 编译阶段&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">&lt;/span>&lt;span class="k">FROM&lt;/span>&lt;span class="s"> golang:1.17-alpine AS build&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">&lt;/span>&lt;span class="c"># GO111MODULE=on: 强制开启gomod&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">&lt;/span>&lt;span class="c"># GOPROXY=&amp;#34;https://goproxy.cn,direct&amp;#34;: 使用国内七牛云包代理&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">&lt;/span>&lt;span class="c"># CGO_ENABLED=0: 关闭cgo，否则在alpine不可运行。&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">&lt;/span>&lt;span class="k">ENV&lt;/span> &lt;span class="nv">GO111MODULE&lt;/span>&lt;span class="o">=&lt;/span>on &lt;span class="se">\
&lt;/span>&lt;span class="se">&lt;/span> &lt;span class="nv">CGO_ENABLED&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">0&lt;/span> &lt;span class="se">\
&lt;/span>&lt;span class="se">&lt;/span> &lt;span class="nv">GOOS&lt;/span>&lt;span class="o">=&lt;/span>linux &lt;span class="se">\
&lt;/span>&lt;span class="se">&lt;/span> &lt;span class="nv">GOARCH&lt;/span>&lt;span class="o">=&lt;/span>amd64 &lt;span class="se">\
&lt;/span>&lt;span class="se">&lt;/span> &lt;span class="nv">GOPROXY&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;https://goproxy.cn,direct&amp;#34;&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">&lt;/span>&lt;span class="c"># 拷贝源码&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">&lt;/span>&lt;span class="k">WORKDIR&lt;/span>&lt;span class="s"> /go/src/&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">&lt;/span>&lt;span class="k">COPY&lt;/span> main.go .&lt;span class="err">
&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">&lt;/span>&lt;span class="c"># 预下载依赖 modules 到容器本地 cache&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">&lt;/span>&lt;span class="k">RUN&lt;/span> go mod init example.com/httpserver&lt;span class="err">
&lt;/span>&lt;span class="err">&lt;/span>&lt;span class="k">RUN&lt;/span> go mod tidy&lt;span class="err">
&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">&lt;/span>&lt;span class="c"># 编译go程序&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">&lt;/span>&lt;span class="k">RUN&lt;/span> go build -o /tmp/httpserver&lt;span class="err">
&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">&lt;/span>&lt;span class="c"># 运行阶段&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">&lt;/span>&lt;span class="k">FROM&lt;/span>&lt;span class="s"> scratch&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">&lt;/span>&lt;span class="c"># 拷贝编译阶段编译好的程序包&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">&lt;/span>&lt;span class="k">COPY&lt;/span> --from&lt;span class="o">=&lt;/span>build /tmp/httpserver /bin/httpserver&lt;span class="err">
&lt;/span>&lt;span class="err">&lt;/span>&lt;span class="c"># 开放的端口&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">&lt;/span>&lt;span class="k">EXPOSE&lt;/span>&lt;span class="s"> 8080&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">&lt;/span>&lt;span class="c"># 容器启动执行命令，启动httpserver服务&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">&lt;/span>&lt;span class="k">ENTRYPOINT&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="s2">&amp;#34;/bin/httpserver&amp;#34;&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="err">
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>测试运行：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">docker build -t ccx/httpserver:v0.0.2 .
docker run -d --name httpserver -p 9090:8080 -e &lt;span class="nv">VERSION&lt;/span>&lt;span class="o">=&lt;/span>v0.0.2 ccx/httpserver:v0.0.2
docker logs -f httpserver
curl -v localhost:9090/healthz -H &lt;span class="s2">&amp;#34;ttt:yyy&amp;#34;&lt;/span>
&lt;span class="c1"># 镜像比较&lt;/span>
docker images&lt;span class="p">|&lt;/span>grep httpserver
ccx/httpserver v0.0.2 1fc9919e6afa About a minute ago 9.93MB
ccx/httpserver v0.0.1 22fc44df77a6 &lt;span class="m">1&lt;/span> days ago 558MB
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>基础镜像差异: Dockerfile3：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-Dockerfile" data-lang="Dockerfile">&lt;span class="c"># 编译阶段&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">&lt;/span>&lt;span class="k">FROM&lt;/span>&lt;span class="s"> golang:1.17-alpine AS build&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">&lt;/span>&lt;span class="c"># GO111MODULE=on: 强制开启gomod&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">&lt;/span>&lt;span class="c"># GOPROXY=&amp;#34;https://goproxy.cn,direct&amp;#34;: 使用国内七牛云包代理&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">&lt;/span>&lt;span class="c"># CGO_ENABLED=0: 关闭cgo，否则在alpine不可运行。&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">&lt;/span>&lt;span class="k">ENV&lt;/span> &lt;span class="nv">GO111MODULE&lt;/span>&lt;span class="o">=&lt;/span>on &lt;span class="se">\
&lt;/span>&lt;span class="se">&lt;/span> &lt;span class="nv">CGO_ENABLED&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">0&lt;/span> &lt;span class="se">\
&lt;/span>&lt;span class="se">&lt;/span> &lt;span class="nv">GOOS&lt;/span>&lt;span class="o">=&lt;/span>linux &lt;span class="se">\
&lt;/span>&lt;span class="se">&lt;/span> &lt;span class="nv">GOARCH&lt;/span>&lt;span class="o">=&lt;/span>amd64 &lt;span class="se">\
&lt;/span>&lt;span class="se">&lt;/span> &lt;span class="nv">GOPROXY&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;https://goproxy.cn,direct&amp;#34;&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">&lt;/span>&lt;span class="c"># 拷贝源码&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">&lt;/span>&lt;span class="k">WORKDIR&lt;/span>&lt;span class="s"> /go/src/&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">&lt;/span>&lt;span class="k">COPY&lt;/span> main.go .&lt;span class="err">
&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">&lt;/span>&lt;span class="c"># 预下载依赖 modules 到容器本地 cache&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">&lt;/span>&lt;span class="k">RUN&lt;/span> go mod init example.com/httpserver&lt;span class="err">
&lt;/span>&lt;span class="err">&lt;/span>&lt;span class="k">RUN&lt;/span> go mod tidy&lt;span class="err">
&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">&lt;/span>&lt;span class="c"># 编译go程序&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">&lt;/span>&lt;span class="k">RUN&lt;/span> go build -o /tmp/httpserver&lt;span class="err">
&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">&lt;/span>&lt;span class="c"># 运行阶段&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">&lt;/span>&lt;span class="k">FROM&lt;/span>&lt;span class="s"> alpine:latest&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">&lt;/span>&lt;span class="c"># 拷贝编译阶段编译好的程序包&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">&lt;/span>&lt;span class="k">COPY&lt;/span> --from&lt;span class="o">=&lt;/span>build /tmp/httpserver /bin/httpserver&lt;span class="err">
&lt;/span>&lt;span class="err">&lt;/span>&lt;span class="c"># 开放的端口&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">&lt;/span>&lt;span class="k">EXPOSE&lt;/span>&lt;span class="s"> 8080&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">&lt;/span>&lt;span class="c"># 容器启动执行命令，启动httpserver服务&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">&lt;/span>&lt;span class="k">ENTRYPOINT&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="s2">&amp;#34;/bin/httpserver&amp;#34;&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="err">
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>测试&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">docker build -t ccx/httpserver:v0.0.3 .
docker run -d --name httpserver -p 9090:8080 -e &lt;span class="nv">VERSION&lt;/span>&lt;span class="o">=&lt;/span>v0.0.3 ccx/httpserver:v0.0.3
docker logs -f httpserver
curl -v localhost:9090/healthz -H &lt;span class="s2">&amp;#34;ttt:yyy&amp;#34;&lt;/span>
&lt;span class="c1"># 镜像比较&lt;/span>
docker images&lt;span class="p">|&lt;/span>grep httpserver
ccx/httpserver v0.0.3 e6ccaa261248 &lt;span class="m">29&lt;/span> seconds ago 15.5MB
ccx/httpserver v0.0.2 1fc9919e6afa &lt;span class="m">4&lt;/span> minutes ago 9.93MB
ccx/httpserver v0.0.1 22fc44df77a6 &lt;span class="m">1&lt;/span> days ago 558MB
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="问题同样的一份代码在不同环境中可以打出完全一样的制品吗">问题：同样的一份代码，在不同环境中可以打出完全一样的制品吗？&lt;/h2>
&lt;blockquote>
&lt;p>&lt;strong>可信要求&lt;/strong>&lt;/p>
&lt;/blockquote>
&lt;p>可能导致差异的几点因素：&lt;/p>
&lt;ol>
&lt;li>基础镜像版本
&lt;ol>
&lt;li>原因：基础镜像虽然指定了版本，但不同镜像仓库下同一版本的镜像不能保证一致。&lt;/li>
&lt;li>应对措施：将常用的基础镜像和依赖包（构建镜像过程中的依赖包）存储在私有镜像仓库中。&lt;/li>
&lt;/ol>
&lt;/li>
&lt;li>依赖包的版本
&lt;ol>
&lt;li>原因：&lt;code>go mod tidy&lt;/code> 会拉取依赖包的最新版本，如果某些包有新的发布，构建出的镜像也会有所不同。&lt;/li>
&lt;li>应对措施：通过 &lt;code>go.mod&lt;/code> 文件来锁定具体版本，结合 &lt;code>go.sum&lt;/code> 确保依赖的一致性。&lt;/li>
&lt;/ol>
&lt;/li>
&lt;li>缓存
&lt;ol>
&lt;li>原因：Docker 使用构建缓存来加速构建过程。如果缓存不同，构建结果也可能有所不同。&lt;/li>
&lt;li>应对措施：通过 &amp;ndash;no-cache 选项来禁用缓存，确保每次构建都是全新的。&lt;/li>
&lt;/ol>
&lt;/li>
&lt;/ol>
&lt;h2 id="namespace">Namespace&lt;/h2>
&lt;h3 id="接口测试">接口测试&lt;/h3>
&lt;h4 id="进入容器测试">进入容器测试&lt;/h4>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">docker exec -it httpserver sh
/opt/modules/httpserver # curl -v localhost:8080/healthz -H &amp;#34;ttt:yyy&amp;#34;
sh: curl: not found
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h4 id="宿主机测试">宿主机测试&lt;/h4>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">curl -v localhost:9090/healthz -H &amp;#34;ttt:yyy&amp;#34;
* Trying 127.0.0.1:9090...
* TCP_NODELAY set
* Connected to localhost (127.0.0.1) port 9090 (#0)
&amp;gt; GET /healthz HTTP/1.1
&amp;gt; Host: localhost:9090
&amp;gt; User-Agent: curl/7.68.0
&amp;gt; Accept: */*
&amp;gt; ttt:yyy
&amp;gt;
* Mark bundle as not supporting multiuse
&amp;lt; HTTP/1.1 200 OK
&amp;lt; Accept: */*
&amp;lt; Content-Type: application/json; charset=utf-8
&amp;lt; Ttt: yyy
&amp;lt; User-Agent: curl/7.68.0
&amp;lt; Version: v0.0.1
&amp;lt; Date: Thu, 06 Oct 2022 10:07:17 GMT
&amp;lt; Content-Length: 18
&amp;lt;
* Connection #0 to host localhost left intact
{&amp;#34;message&amp;#34;:&amp;#34;pong&amp;#34;}%
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="查看容器信息">查看容器信息&lt;/h3>
&lt;p>获取&lt;code>Pid&lt;/code>&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">docker ps | grep httpserver
docker inspect httpserver|grep -i pid
&amp;#34;Pid&amp;#34;: 36309,
&amp;#34;PidMode&amp;#34;: &amp;#34;&amp;#34;,
&amp;#34;PidsLimit&amp;#34;: null,
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="查看容器-ip">查看容器 ip&lt;/h3>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">docker exec -it httpserver sh
/opt/modules/httpserver # ip a
1: lo: &amp;lt;LOOPBACK,UP,LOWER_UP&amp;gt; mtu 65536 qdisc noqueue state UNKNOWN qlen 1000
link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
inet 127.0.0.1/8 scope host lo
valid_lft forever preferred_lft forever
23: eth0@if24: &amp;lt;BROADCAST,MULTICAST,UP,LOWER_UP,M-DOWN&amp;gt; mtu 1500 qdisc noqueue state UP
link/ether 02:42:ac:11:00:02 brd ff:ff:ff:ff:ff:ff
inet 172.17.0.2/16 brd 172.17.255.255 scope global eth0
valid_lft forever preferred_lft forever
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="从宿主机通过-namespace-访问容器的网络">从宿主机通过 namespace 访问容器的网络&lt;/h3>
&lt;p>查看当前系统的 namespace：&lt;code>lsns –t &amp;lt;type&amp;gt;&lt;/code>&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">lsns -t net
NS TYPE NPROCS PID USER NETNSID NSFS COMMAND
4026531992 net 124 9158 cjx unassigned /lib/systemd/systemd --user
4026533051 net 2 19842 cjx unassigned /usr/share/code/code --type=zygo
4026533633 net 25 9679 cjx unassigned /opt/google/chrome/chrome --type
4026533725 net 1 9680 cjx unassigned /opt/google/chrome/nacl_helper
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>查看某进程的 namespace：&lt;code>ls -la /proc/&amp;lt;pid&amp;gt;/ns/&lt;/code>&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">sudo ls -la /proc/36309/ns/
总用量 0
dr-x--x--x 2 root root 0 10月 6 17:55 .
dr-xr-xr-x 9 root root 0 10月 6 17:55 ..
lrwxrwxrwx 1 root root 0 10月 6 18:03 cgroup -&amp;gt; &amp;#39;cgroup:[4026531835]&amp;#39;
lrwxrwxrwx 1 root root 0 10月 6 17:56 ipc -&amp;gt; &amp;#39;ipc:[4026533336]&amp;#39;
lrwxrwxrwx 1 root root 0 10月 6 17:56 mnt -&amp;gt; &amp;#39;mnt:[4026533334]&amp;#39;
lrwxrwxrwx 1 root root 0 10月 6 17:55 net -&amp;gt; &amp;#39;net:[4026533339]&amp;#39;
lrwxrwxrwx 1 root root 0 10月 6 17:56 pid -&amp;gt; &amp;#39;pid:[4026533337]&amp;#39;
lrwxrwxrwx 1 root root 0 10月 6 18:03 pid_for_children -&amp;gt; &amp;#39;pid:[4026533337]&amp;#39;
lrwxrwxrwx 1 root root 0 10月 6 18:03 user -&amp;gt; &amp;#39;user:[4026531837]&amp;#39;
lrwxrwxrwx 1 root root 0 10月 6 17:56 uts -&amp;gt; &amp;#39;uts:[4026533335]&amp;#39;
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>进入某 namespace 运行命令：&lt;code>nsenter -t &amp;lt;pid&amp;gt; -n ip addr&lt;/code>&lt;/p>
&lt;ul>
&lt;li>-n: 指定网络 ns&lt;/li>
&lt;/ul>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;span class="lnt">8
&lt;/span>&lt;span class="lnt">9
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">sudo nsenter -t 36309 -n ip a
1: lo: &amp;lt;LOOPBACK,UP,LOWER_UP&amp;gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000
link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
inet 127.0.0.1/8 scope host lo
valid_lft forever preferred_lft forever
23: eth0@if24: &amp;lt;BROADCAST,MULTICAST,UP,LOWER_UP&amp;gt; mtu 1500 qdisc noqueue state UP group default
link/ether 02:42:ac:11:00:02 brd ff:ff:ff:ff:ff:ff link-netnsid 0
inet 172.17.0.2/16 brd 172.17.255.255 scope global eth0
valid_lft forever preferred_lft forever
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="测试接口容器内没有安装-curl只能通过这个方法测试否则需要把接口端口开放出来">测试接口(容器内没有安装 curl，只能通过这个方法测试，否则需要把接口端口开放出来)&lt;/h3>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">sudo nsenter -t 36309 -n curl -v localhost:8080/healthz -H &amp;#34;ttt:yyy&amp;#34;
* Trying 127.0.0.1:8080...
* TCP_NODELAY set
* Connected to localhost (127.0.0.1) port 8080 (#0)
&amp;gt; GET /healthz HTTP/1.1
&amp;gt; Host: localhost:8080
&amp;gt; User-Agent: curl/7.68.0
&amp;gt; Accept: */*
&amp;gt; ttt:yyy
&amp;gt;
* Mark bundle as not supporting multiuse
&amp;lt; HTTP/1.1 200 OK
&amp;lt; Accept: */*
&amp;lt; Content-Type: application/json; charset=utf-8
&amp;lt; Ttt: yyy
&amp;lt; User-Agent: curl/7.68.0
&amp;lt; Version: v0.0.1
&amp;lt; Date: Thu, 06 Oct 2022 10:05:41 GMT
&amp;lt; Content-Length: 18
&amp;lt;
* Connection #0 to host localhost left intact
{&amp;#34;message&amp;#34;:&amp;#34;pong&amp;#34;}%
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="将新进程放入独立的网络">将新进程放入独立的网络&lt;/h3>
&lt;p>在新 network namespace 执行 sleep 指令：&lt;code>sudo unshare -fn sleep 60&lt;/code>&lt;/p>
&lt;ul>
&lt;li>-fn: 放入独立的网络 ns&lt;/li>
&lt;/ul>
&lt;p>查看进程信息&lt;code>sudo ps -ef|grep 'sleep 60'&lt;/code>&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">sudo ps -ef&lt;span class="p">|&lt;/span>grep &lt;span class="s1">&amp;#39;sleep 60&amp;#39;&lt;/span>
root &lt;span class="m">13747&lt;/span> &lt;span class="m">12656&lt;/span> &lt;span class="m">0&lt;/span> 12:31 pts/0 00:00:00 sudo unshare -fn sleep &lt;span class="m">60&lt;/span>
root &lt;span class="m">13748&lt;/span> &lt;span class="m">13747&lt;/span> &lt;span class="m">0&lt;/span> 12:31 pts/0 00:00:00 unshare -fn sleep &lt;span class="m">60&lt;/span>
root &lt;span class="m">13749&lt;/span> &lt;span class="m">13748&lt;/span> &lt;span class="m">0&lt;/span> 12:31 pts/0 00:00:00 sleep &lt;span class="m">60&lt;/span>
cjx &lt;span class="m">13766&lt;/span> &lt;span class="m">13489&lt;/span> &lt;span class="m">0&lt;/span> 12:31 pts/1 00:00:00 grep --color&lt;span class="o">=&lt;/span>auto sleep &lt;span class="m">60&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>进入改进程所在 Namespace 查看网络配置，与主机不一致&lt;code>sudo nsenter -t 13489 -n ip a&lt;/code>&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">sudo nsenter -t &lt;span class="m">13489&lt;/span> -n ip a
1: lo: &amp;lt;LOOPBACK&amp;gt; mtu &lt;span class="m">65536&lt;/span> qdisc noop state DOWN group default qlen &lt;span class="m">1000&lt;/span>
link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>查看网络 Namespace&lt;code>lsns -t net&lt;/code>&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">lsns -t net
NS TYPE NPROCS PID USER NETNSID NSFS COMMAND
&lt;span class="m">4026531840&lt;/span> net &lt;span class="m">66&lt;/span> &lt;span class="m">8880&lt;/span> cjx unassigned /lib/systemd/systemd --user
sudo lsns -t net
NS TYPE NPROCS PID USER NETNSID NSFS COMMAND
&lt;span class="m">4026531840&lt;/span> net &lt;span class="m">327&lt;/span> &lt;span class="m">1&lt;/span> root unassigned /sbin/init auto noprompt
&lt;span class="m">4026532649&lt;/span> net &lt;span class="m">1&lt;/span> &lt;span class="m">1288&lt;/span> rtkit unassigned /usr/libexec/rtkit-daemon
&lt;span class="m">4026532716&lt;/span> net &lt;span class="m">5&lt;/span> &lt;span class="m">13036&lt;/span> root &lt;span class="m">0&lt;/span> /run/docker/netns/d07ea2c2f615 nginx: master process nginx -g daemon off&lt;span class="p">;&lt;/span>
&lt;span class="m">4026532800&lt;/span> net &lt;span class="m">2&lt;/span> &lt;span class="m">13748&lt;/span> root unassigned unshare -fn sleep &lt;span class="m">60&lt;/span>
sudo ls -la /proc/13748/ns/
total &lt;span class="m">0&lt;/span>
dr-x--x--x &lt;span class="m">2&lt;/span> root root &lt;span class="m">0&lt;/span> Jul &lt;span class="m">18&lt;/span> 12:31 .
dr-xr-xr-x &lt;span class="m">9&lt;/span> root root &lt;span class="m">0&lt;/span> Jul &lt;span class="m">18&lt;/span> 12:31 ..
lrwxrwxrwx &lt;span class="m">1&lt;/span> root root &lt;span class="m">0&lt;/span> Jul &lt;span class="m">18&lt;/span> 12:31 cgroup -&amp;gt; &lt;span class="s1">&amp;#39;cgroup:[4026531835]&amp;#39;&lt;/span>
lrwxrwxrwx &lt;span class="m">1&lt;/span> root root &lt;span class="m">0&lt;/span> Jul &lt;span class="m">18&lt;/span> 12:31 ipc -&amp;gt; &lt;span class="s1">&amp;#39;ipc:[4026531839]&amp;#39;&lt;/span>
lrwxrwxrwx &lt;span class="m">1&lt;/span> root root &lt;span class="m">0&lt;/span> Jul &lt;span class="m">18&lt;/span> 12:31 mnt -&amp;gt; &lt;span class="s1">&amp;#39;mnt:[4026531841]&amp;#39;&lt;/span>
lrwxrwxrwx &lt;span class="m">1&lt;/span> root root &lt;span class="m">0&lt;/span> Jul &lt;span class="m">18&lt;/span> 12:31 net -&amp;gt; &lt;span class="s1">&amp;#39;net:[4026532800]&amp;#39;&lt;/span>
lrwxrwxrwx &lt;span class="m">1&lt;/span> root root &lt;span class="m">0&lt;/span> Jul &lt;span class="m">18&lt;/span> 12:31 pid -&amp;gt; &lt;span class="s1">&amp;#39;pid:[4026531836]&amp;#39;&lt;/span>
lrwxrwxrwx &lt;span class="m">1&lt;/span> root root &lt;span class="m">0&lt;/span> Jul &lt;span class="m">18&lt;/span> 12:31 pid_for_children -&amp;gt; &lt;span class="s1">&amp;#39;pid:[4026531836]&amp;#39;&lt;/span>
lrwxrwxrwx &lt;span class="m">1&lt;/span> root root &lt;span class="m">0&lt;/span> Jul &lt;span class="m">18&lt;/span> 12:31 &lt;span class="nb">time&lt;/span> -&amp;gt; &lt;span class="s1">&amp;#39;time:[4026531834]&amp;#39;&lt;/span>
lrwxrwxrwx &lt;span class="m">1&lt;/span> root root &lt;span class="m">0&lt;/span> Jul &lt;span class="m">18&lt;/span> 12:31 time_for_children -&amp;gt; &lt;span class="s1">&amp;#39;time:[4026531834]&amp;#39;&lt;/span>
lrwxrwxrwx &lt;span class="m">1&lt;/span> root root &lt;span class="m">0&lt;/span> Jul &lt;span class="m">18&lt;/span> 12:31 user -&amp;gt; &lt;span class="s1">&amp;#39;user:[4026531837]&amp;#39;&lt;/span>
lrwxrwxrwx &lt;span class="m">1&lt;/span> root root &lt;span class="m">0&lt;/span> Jul &lt;span class="m">18&lt;/span> 12:31 uts -&amp;gt; &lt;span class="s1">&amp;#39;uts:[4026531838]&amp;#39;&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="cgroup-cpu">cgroup cpu&lt;/h2>
&lt;p>代码：main.go&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="kn">package&lt;/span> &lt;span class="nx">main&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="nf">main&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">go&lt;/span> &lt;span class="kd">func&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}()&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>在 cgroup cpu 子系统目录中创建目录结构&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;span class="lnt">33
&lt;/span>&lt;span class="lnt">34
&lt;/span>&lt;span class="lnt">35
&lt;/span>&lt;span class="lnt">36
&lt;/span>&lt;span class="lnt">37
&lt;/span>&lt;span class="lnt">38
&lt;/span>&lt;span class="lnt">39
&lt;/span>&lt;span class="lnt">40
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="nb">cd&lt;/span> /sys/fs/cgroup/cpu
sudo mkdir cpudemo
&lt;span class="nb">cd&lt;/span> cpudemo
➜ cpudemo ll
总用量 &lt;span class="m">0&lt;/span>
drwxr-xr-x &lt;span class="m">2&lt;/span> root root &lt;span class="m">0&lt;/span> 10月 &lt;span class="m">7&lt;/span> 20:37 .
dr-xr-xr-x &lt;span class="m">7&lt;/span> root root &lt;span class="m">0&lt;/span> 10月 &lt;span class="m">7&lt;/span> 07:21 ..
-rw-r--r-- &lt;span class="m">1&lt;/span> root root &lt;span class="m">0&lt;/span> 10月 &lt;span class="m">7&lt;/span> 20:37 cgroup.clone_children
-rw-r--r-- &lt;span class="m">1&lt;/span> root root &lt;span class="m">0&lt;/span> 10月 &lt;span class="m">7&lt;/span> 20:37 cgroup.procs
-r--r--r-- &lt;span class="m">1&lt;/span> root root &lt;span class="m">0&lt;/span> 10月 &lt;span class="m">7&lt;/span> 20:37 cpuacct.stat
-rw-r--r-- &lt;span class="m">1&lt;/span> root root &lt;span class="m">0&lt;/span> 10月 &lt;span class="m">7&lt;/span> 20:37 cpuacct.usage
-r--r--r-- &lt;span class="m">1&lt;/span> root root &lt;span class="m">0&lt;/span> 10月 &lt;span class="m">7&lt;/span> 20:37 cpuacct.usage_all
-r--r--r-- &lt;span class="m">1&lt;/span> root root &lt;span class="m">0&lt;/span> 10月 &lt;span class="m">7&lt;/span> 20:37 cpuacct.usage_percpu
-r--r--r-- &lt;span class="m">1&lt;/span> root root &lt;span class="m">0&lt;/span> 10月 &lt;span class="m">7&lt;/span> 20:37 cpuacct.usage_percpu_sys
-r--r--r-- &lt;span class="m">1&lt;/span> root root &lt;span class="m">0&lt;/span> 10月 &lt;span class="m">7&lt;/span> 20:37 cpuacct.usage_percpu_user
-r--r--r-- &lt;span class="m">1&lt;/span> root root &lt;span class="m">0&lt;/span> 10月 &lt;span class="m">7&lt;/span> 20:37 cpuacct.usage_sys
-r--r--r-- &lt;span class="m">1&lt;/span> root root &lt;span class="m">0&lt;/span> 10月 &lt;span class="m">7&lt;/span> 20:37 cpuacct.usage_user
-rw-r--r-- &lt;span class="m">1&lt;/span> root root &lt;span class="m">0&lt;/span> 10月 &lt;span class="m">7&lt;/span> 20:37 cpu.cfs_period_us
-rw-r--r-- &lt;span class="m">1&lt;/span> root root &lt;span class="m">0&lt;/span> 10月 &lt;span class="m">7&lt;/span> 20:37 cpu.cfs_quota_us
-rw-r--r-- &lt;span class="m">1&lt;/span> root root &lt;span class="m">0&lt;/span> 10月 &lt;span class="m">7&lt;/span> 20:37 cpu.shares
-r--r--r-- &lt;span class="m">1&lt;/span> root root &lt;span class="m">0&lt;/span> 10月 &lt;span class="m">7&lt;/span> 20:37 cpu.stat
-rw-r--r-- &lt;span class="m">1&lt;/span> root root &lt;span class="m">0&lt;/span> 10月 &lt;span class="m">7&lt;/span> 20:37 cpu.uclamp.max
-rw-r--r-- &lt;span class="m">1&lt;/span> root root &lt;span class="m">0&lt;/span> 10月 &lt;span class="m">7&lt;/span> 20:37 cpu.uclamp.min
-rw-r--r-- &lt;span class="m">1&lt;/span> root root &lt;span class="m">0&lt;/span> 10月 &lt;span class="m">7&lt;/span> 20:37 notify_on_release
-rw-r--r-- &lt;span class="m">1&lt;/span> root root &lt;span class="m">0&lt;/span> 10月 &lt;span class="m">7&lt;/span> 20:37 tasks
➜ cpudemo cat cpu.shares
&lt;span class="m">1024&lt;/span>
限制使用多少 CPU 时间片，-1 表示不限制
➜ cpudemo cat cpu.cfs_quota_us
-1
一个 CPU 时间片数
➜ cpudemo cat cpu.cfs_period_us
&lt;span class="m">100000&lt;/span>
监控的进程 ID，新建出来的为空
➜ cpudemo cat cgroup.procs
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>&lt;code>cpu.shares&lt;/code>、&lt;code>cpu.cfs_quota_us&lt;/code>、&lt;code>cpu.cfs_period_us&lt;/code>关系：&lt;/p>
&lt;p>cpu.cfs_quota_us 与 cpu.cfs_period_us 一起使用，用于限制 cgroup 中所有进程在一定时间周期内可以使用的 CPU 时间总量。这个参数提供了一种硬性限制，确保 cgroup 中的进程不会超过指定的 CPU 使用量。&lt;/p>
&lt;p>cpu.shares 是一个相对权重参数，它决定了在多个 cgroup 之间竞争 CPU 资源时，每个 cgroup 能够获得的 CPU 时间的相对比例。这个参数并不提供硬性限制，而是在资源竞争时影响 CPU 时间的分配比例。&lt;/p>
&lt;p>当 cpu.cfs_quota_us 和 cpu.shares 同时设置时，它们会按照以下方式共同作用：&lt;/p>
&lt;p>资源竞争时的优先级：如果系统上的 CPU 资源充足，不在竞争状态，那么所有 cgroup 都可以使用更多的 CPU 时间，不会受到 cpu.shares 设置的限制。但是，如果 CPU 资源紧张，多个 cgroup 之间开始竞争 CPU 时间，cpu.shares 的值将决定它们获取 CPU 时间的相对权重。&lt;/p>
&lt;h3 id="运行-busyloop">运行 busyloop&lt;/h3>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">➜ busyloop git:&lt;span class="o">(&lt;/span>main&lt;span class="o">)&lt;/span> ✗ go build -o busyloop main.go
➜ busyloop git:&lt;span class="o">(&lt;/span>main&lt;span class="o">)&lt;/span> ✗ ll
总用量 1.2M
-rwxrwxr-x &lt;span class="m">1&lt;/span> cjx cjx 1.2M 10月 &lt;span class="m">7&lt;/span> 20:42 busyloop
-rw-rw-r-- &lt;span class="m">1&lt;/span> cjx cjx &lt;span class="m">73&lt;/span> 10月 &lt;span class="m">7&lt;/span> 20:34 main.go
➜ busyloop git:&lt;span class="o">(&lt;/span>main&lt;span class="o">)&lt;/span> ✗ ./busyloop
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>执行 top 查看 CPU 使用情况，CPU 占用 200%&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;span class="lnt">8
&lt;/span>&lt;span class="lnt">9
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">top - 20:43:20 up 13:21, &lt;span class="m">1&lt;/span> user, load average: 1.62, 0.87, 0.91
任务: &lt;span class="m">531&lt;/span> total, &lt;span class="m">3&lt;/span> running, &lt;span class="m">527&lt;/span> sleeping, &lt;span class="m">0&lt;/span> stopped, &lt;span class="m">1&lt;/span> zombie
%Cpu&lt;span class="o">(&lt;/span>s&lt;span class="o">)&lt;/span>: 11.1 us, 0.3 sy, 0.0 ni, 87.2 id, 0.0 wa, 0.0 hi, 1.4 si, 0.0 st
MiB Mem : 128749.5 total, 117783.0 free, 5873.8 used, 5092.6 buff/cache
MiB Swap: 0.0 total, 0.0 free, 0.0 used. 121378.7 avail Mem
进程号 USER PR NI VIRT RES SHR %CPU %MEM TIME+ COMMAND
&lt;span class="m">52435&lt;/span> cjx &lt;span class="m">20&lt;/span> &lt;span class="m">0&lt;/span> &lt;span class="m">702364&lt;/span> &lt;span class="m">1160&lt;/span> &lt;span class="m">648&lt;/span> R 200.0 0.0 0:44.07 busyloop
......
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="c1"># 通过 cgroup 限制 cpu&lt;/span>
&lt;span class="nb">cd&lt;/span> /sys/fs/cgroup/cpu/cpudemo
&lt;span class="c1"># 把进程添加到 cgroup 进程配置组&lt;/span>
&lt;span class="c1"># echo ps -ef|grep busyloop|grep -v grep|awk &amp;#39;{print $2}&amp;#39; &amp;gt; cgroup.procs&lt;/span>
➜ cpudemo ps -ef&lt;span class="p">|&lt;/span>grep busyloop&lt;span class="p">|&lt;/span>grep -v grep&lt;span class="p">|&lt;/span>awk &lt;span class="s1">&amp;#39;{print $2}&amp;#39;&lt;/span>
&lt;span class="m">52435&lt;/span>
➜ cpudemo cat cgroup.procs
&lt;span class="m">52435&lt;/span>
&lt;span class="c1"># 设置 cpuquota&lt;/span>
&lt;span class="nb">echo&lt;/span> &lt;span class="m">10000&lt;/span> &amp;gt; cpu.cfs_quota_us
cat cpu.cfs_quota_us
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>执行 top 查看 CPU 使用情况，CPU 占用变为10%(cpu.cfs_quota_us/cpu.cfs_period_us -&amp;gt; 10000/100000)&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;span class="lnt">8
&lt;/span>&lt;span class="lnt">9
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">top - 20:49:11 up 13:27, &lt;span class="m">1&lt;/span> user, load average: 1.28, 1.58, 1.26
任务: &lt;span class="m">531&lt;/span> total, &lt;span class="m">3&lt;/span> running, &lt;span class="m">527&lt;/span> sleeping, &lt;span class="m">0&lt;/span> stopped, &lt;span class="m">1&lt;/span> zombie
%Cpu&lt;span class="o">(&lt;/span>s&lt;span class="o">)&lt;/span>: 1.7 us, 0.5 sy, 0.0 ni, 97.7 id, 0.0 wa, 0.0 hi, 0.1 si, 0.0 st
MiB Mem : 128749.5 total, 117765.6 free, 5888.9 used, 5095.0 buff/cache
MiB Swap: 0.0 total, 0.0 free, 0.0 used. 121364.8 avail Mem
进程号 USER PR NI VIRT RES SHR %CPU %MEM TIME+ COMMAND
&lt;span class="m">4507&lt;/span> cjx &lt;span class="m">20&lt;/span> &lt;span class="m">0&lt;/span> 1125.5g &lt;span class="m">481848&lt;/span> &lt;span class="m">208608&lt;/span> S 11.0 0.4 46:28.85 chrome
&lt;span class="m">52435&lt;/span> cjx &lt;span class="m">20&lt;/span> &lt;span class="m">0&lt;/span> &lt;span class="m">702364&lt;/span> &lt;span class="m">1160&lt;/span> &lt;span class="m">648&lt;/span> R 10.3 0.0 11:28.43 busyloop
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="善后删除">善后删除&lt;/h3>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">sudo apt install cgroup-tools
sudo cgdelete cpu:cpudemo
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="cgroup-memory">cgroup memory&lt;/h2>
&lt;p>在 cgroup memory 子系统目录中创建目录结构&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;span class="lnt">33
&lt;/span>&lt;span class="lnt">34
&lt;/span>&lt;span class="lnt">35
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="nb">cd&lt;/span> /sys/fs/cgroup/memory
mkdir memorydemo
&lt;span class="nb">cd&lt;/span> memorydemo
ls -la
总用量 &lt;span class="m">0&lt;/span>
drwxr-xr-x &lt;span class="m">2&lt;/span> root root &lt;span class="m">0&lt;/span> 10月 &lt;span class="m">7&lt;/span> 21:01 .
dr-xr-xr-x &lt;span class="m">7&lt;/span> root root &lt;span class="m">0&lt;/span> 10月 &lt;span class="m">7&lt;/span> 07:21 ..
-rw-r--r-- &lt;span class="m">1&lt;/span> root root &lt;span class="m">0&lt;/span> 10月 &lt;span class="m">7&lt;/span> 21:02 cgroup.clone_children
--w--w--w- &lt;span class="m">1&lt;/span> root root &lt;span class="m">0&lt;/span> 10月 &lt;span class="m">7&lt;/span> 21:02 cgroup.event_control
-rw-r--r-- &lt;span class="m">1&lt;/span> root root &lt;span class="m">0&lt;/span> 10月 &lt;span class="m">7&lt;/span> 21:02 cgroup.procs &lt;span class="c1"># 管控的进程&lt;/span>
-rw-r--r-- &lt;span class="m">1&lt;/span> root root &lt;span class="m">0&lt;/span> 10月 &lt;span class="m">7&lt;/span> 21:02 memory.failcnt
--w------- &lt;span class="m">1&lt;/span> root root &lt;span class="m">0&lt;/span> 10月 &lt;span class="m">7&lt;/span> 21:02 memory.force_empty
-rw-r--r-- &lt;span class="m">1&lt;/span> root root &lt;span class="m">0&lt;/span> 10月 &lt;span class="m">7&lt;/span> 21:02 memory.kmem.failcnt
-rw-r--r-- &lt;span class="m">1&lt;/span> root root &lt;span class="m">0&lt;/span> 10月 &lt;span class="m">7&lt;/span> 21:02 memory.kmem.limit_in_bytes
-rw-r--r-- &lt;span class="m">1&lt;/span> root root &lt;span class="m">0&lt;/span> 10月 &lt;span class="m">7&lt;/span> 21:02 memory.kmem.max_usage_in_bytes
-r--r--r-- &lt;span class="m">1&lt;/span> root root &lt;span class="m">0&lt;/span> 10月 &lt;span class="m">7&lt;/span> 21:02 memory.kmem.slabinfo
-rw-r--r-- &lt;span class="m">1&lt;/span> root root &lt;span class="m">0&lt;/span> 10月 &lt;span class="m">7&lt;/span> 21:02 memory.kmem.tcp.failcnt
-rw-r--r-- &lt;span class="m">1&lt;/span> root root &lt;span class="m">0&lt;/span> 10月 &lt;span class="m">7&lt;/span> 21:02 memory.kmem.tcp.limit_in_bytes
-rw-r--r-- &lt;span class="m">1&lt;/span> root root &lt;span class="m">0&lt;/span> 10月 &lt;span class="m">7&lt;/span> 21:02 memory.kmem.tcp.max_usage_in_bytes
-r--r--r-- &lt;span class="m">1&lt;/span> root root &lt;span class="m">0&lt;/span> 10月 &lt;span class="m">7&lt;/span> 21:02 memory.kmem.tcp.usage_in_bytes
-r--r--r-- &lt;span class="m">1&lt;/span> root root &lt;span class="m">0&lt;/span> 10月 &lt;span class="m">7&lt;/span> 21:02 memory.kmem.usage_in_bytes
-rw-r--r-- &lt;span class="m">1&lt;/span> root root &lt;span class="m">0&lt;/span> 10月 &lt;span class="m">7&lt;/span> 21:02 memory.limit_in_bytes
-rw-r--r-- &lt;span class="m">1&lt;/span> root root &lt;span class="m">0&lt;/span> 10月 &lt;span class="m">7&lt;/span> 21:02 memory.max_usage_in_bytes
-rw-r--r-- &lt;span class="m">1&lt;/span> root root &lt;span class="m">0&lt;/span> 10月 &lt;span class="m">7&lt;/span> 21:02 memory.move_charge_at_immigrate
-r--r--r-- &lt;span class="m">1&lt;/span> root root &lt;span class="m">0&lt;/span> 10月 &lt;span class="m">7&lt;/span> 21:02 memory.numa_stat
-rw-r--r-- &lt;span class="m">1&lt;/span> root root &lt;span class="m">0&lt;/span> 10月 &lt;span class="m">7&lt;/span> 21:02 memory.oom_control
---------- &lt;span class="m">1&lt;/span> root root &lt;span class="m">0&lt;/span> 10月 &lt;span class="m">7&lt;/span> 21:02 memory.pressure_level
-rw-r--r-- &lt;span class="m">1&lt;/span> root root &lt;span class="m">0&lt;/span> 10月 &lt;span class="m">7&lt;/span> 21:02 memory.soft_limit_in_bytes
-r--r--r-- &lt;span class="m">1&lt;/span> root root &lt;span class="m">0&lt;/span> 10月 &lt;span class="m">7&lt;/span> 21:02 memory.stat
-rw-r--r-- &lt;span class="m">1&lt;/span> root root &lt;span class="m">0&lt;/span> 10月 &lt;span class="m">7&lt;/span> 21:02 memory.swappiness
-r--r--r-- &lt;span class="m">1&lt;/span> root root &lt;span class="m">0&lt;/span> 10月 &lt;span class="m">7&lt;/span> 21:02 memory.usage_in_bytes
-rw-r--r-- &lt;span class="m">1&lt;/span> root root &lt;span class="m">0&lt;/span> 10月 &lt;span class="m">7&lt;/span> 21:02 memory.use_hierarchy
-rw-r--r-- &lt;span class="m">1&lt;/span> root root &lt;span class="m">0&lt;/span> 10月 &lt;span class="m">7&lt;/span> 21:02 notify_on_release
-rw-r--r-- &lt;span class="m">1&lt;/span> root root &lt;span class="m">0&lt;/span> 10月 &lt;span class="m">7&lt;/span> 21:02 tasks
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>通过 cgroup 限制 memory&lt;/p>
&lt;p>把进程添加到 cgroup 进程配置组&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="nb">echo&lt;/span> &amp;lt;pid&amp;gt; &amp;gt; cgroup.procs
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>设置 memory.limit_in_bytes&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="nb">echo&lt;/span> &lt;span class="m">104960000&lt;/span> &amp;gt; memory.limit_in_bytes
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="overlayfs">OverlayFS&lt;/h2></description></item><item><title>Controller Manager</title><link>https://mkbooks.github.io/blog/p/controller-manager/</link><pubDate>Sun, 12 Feb 2023 21:29:00 +0800</pubDate><guid>https://mkbooks.github.io/blog/p/controller-manager/</guid><description>&lt;h1 id="查看-controller-manager-的帮助">查看 &amp;ldquo;Controller Manager&amp;rdquo; 的帮助&lt;/h1>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">k8s@k8s:~/101$ ks get pod
NAME READY STATUS RESTARTS AGE
coredns-7f6cbbb7b8-6zd49 1/1 Running 11 (15d ago) 64d
coredns-7f6cbbb7b8-7kshr 1/1 Running 11 (15d ago) 64d
etcd-k8s 1/1 Running 11 (15d ago) 64d
kube-apiserver-k8s 1/1 Running 11 (15d ago) 64d
kube-controller-manager-k8s 1/1 Running 11 (15d ago) 64d
kube-proxy-m9kgw 1/1 Running 11 (15d ago) 64d
kube-scheduler-k8s 1/1 Running 11 (15d ago) 64d
k8s@k8s:~/101$ ks exec -it kube-controller-manager-k8s -- kube-controller-manager -h
The Kubernetes controller manager is a daemon that embeds
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div></description></item><item><title>停止deployment不删除</title><link>https://mkbooks.github.io/blog/p/%E5%81%9C%E6%AD%A2deployment%E4%B8%8D%E5%88%A0%E9%99%A4/</link><pubDate>Fri, 10 Feb 2023 13:00:00 +0800</pubDate><guid>https://mkbooks.github.io/blog/p/%E5%81%9C%E6%AD%A2deployment%E4%B8%8D%E5%88%A0%E9%99%A4/</guid><description>&lt;p>将 &lt;code>replicas&lt;/code> 设为 0&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">k scale --replicas=0 deployment/deployment_name
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div></description></item><item><title>使用 helm 遇到的问题</title><link>https://mkbooks.github.io/blog/p/%E4%BD%BF%E7%94%A8-helm-%E9%81%87%E5%88%B0%E7%9A%84%E9%97%AE%E9%A2%98/</link><pubDate>Tue, 31 Jan 2023 14:30:00 +0800</pubDate><guid>https://mkbooks.github.io/blog/p/%E4%BD%BF%E7%94%A8-helm-%E9%81%87%E5%88%B0%E7%9A%84%E9%97%AE%E9%A2%98/</guid><description>&lt;ul>
&lt;li>版本
&lt;ul>
&lt;li>helm version
&lt;ul>
&lt;li>&lt;code>version.BuildInfo{Version:&amp;quot;v3.7.0&amp;quot;, GitCommit:&amp;quot;eeac83883cb4014fe60267ec6373570374ce770b&amp;quot;, GitTreeState:&amp;quot;clean&amp;quot;, GoVersion:&amp;quot;go1.16.8&amp;quot;}&lt;/code>&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;h1 id="问题-1">问题 1&lt;/h1>
&lt;h2 id="操作">操作&lt;/h2>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">helm repo add bitnami https://charts.bitnami.com/bitnami
helm search repo bitnami | grep mysql
helm repo update
helm install bitnami/mysql --generate-name
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="报错">报错&lt;/h2>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">Error: INSTALLATION FAILED: Kubernetes cluster unreachable: Get &amp;#34;http://localhost:8080/version?timeout=32s&amp;#34;: dial tcp 127.0.0.1:8080: connect: connection refused
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="解决">解决&lt;/h2>
&lt;blockquote>
&lt;p>手动配置 KUBECONFIG 环境变量&lt;/p>
&lt;/blockquote>
&lt;p>临时解决: &lt;code>export KUBECONFIG=/etc/rancher/k3s/k3s.yaml&lt;/code>&lt;/p>
&lt;p>永久解决:&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">vim ~/.bashrc
# 写入内容: export KUBECONFIG=/etc/rancher/k3s/k3s.yaml
source ~/.bashrc
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="原理">原理&lt;/h2>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">helm v3 版本不再需要 Tiller，而是直接访问 ApiServer 来与 k8s 交互，通过环境变量 KUBECONFIG 来读取存有 ApiServre 的地址与 token 的配置文件地址，默认地址为 ~/.kube/config
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div></description></item><item><title>helm 教程</title><link>https://mkbooks.github.io/blog/p/helm-%E6%95%99%E7%A8%8B/</link><pubDate>Tue, 31 Jan 2023 14:20:00 +0800</pubDate><guid>https://mkbooks.github.io/blog/p/helm-%E6%95%99%E7%A8%8B/</guid><description>&lt;ul>
&lt;li>
&lt;p>&lt;a class="link" href="https://helm.sh/" target="_blank" rel="noopener"
>helm docs 官网&lt;/a>&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;a class="link" href="https://helm.sh/zh/docs/" target="_blank" rel="noopener"
>helm docs 中文文档&lt;/a>&lt;/p>
&lt;/li>
&lt;li>
&lt;p>版本&lt;/p>
&lt;ul>
&lt;li>helm version
&lt;ul>
&lt;li>&lt;code>version.BuildInfo{Version:&amp;quot;v3.7.0&amp;quot;, GitCommit:&amp;quot;eeac83883cb4014fe60267ec6373570374ce770b&amp;quot;, GitTreeState:&amp;quot;clean&amp;quot;, GoVersion:&amp;quot;go1.16.8&amp;quot;}&lt;/code>&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;h2 id="基础操作">基础操作&lt;/h2>
&lt;h3 id="仓库">仓库&lt;/h3>
&lt;ul>
&lt;li>查看配置的仓库：&lt;code>helm repo list&lt;/code>&lt;/li>
&lt;li>添加新的仓库：&lt;code>helm repo add&lt;/code>
&lt;ul>
&lt;li>&lt;code>helm repo add brigade https://brigadecore.github.io/charts&lt;/code>&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>更新仓库：&lt;code>helm repo update&lt;/code>&lt;/li>
&lt;li>移除仓库: &lt;code>helm repo remove&lt;/code>&lt;/li>
&lt;/ul>
&lt;h3 id="charts">Charts&lt;/h3>
&lt;ul>
&lt;li>查找可用的charts：&lt;code>helm search hub&lt;/code>
&lt;ul>
&lt;li>&lt;code>helm search hub wordpress&lt;/code>&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>从添加的仓库中查找可用的charts: &lt;code>helm search repo brigade&lt;/code>
&lt;ul>
&lt;li>搜索使用模糊字符串匹配算法: &lt;code>helm search repo bri&lt;/code>&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;h3 id="安装一个-helm-包">安装一个 helm 包&lt;/h3>
&lt;ul>
&lt;li>使用 &lt;code>helm install&lt;/code> 命令来安装一个新的 helm 包。最简单的使用方法只需要传入两个参数：你命名的release名字和你想安装的chart的名称。（如果想让Helm生成一个名称，删除发布名称并使用&amp;ndash;generate-name。）
&lt;ul>
&lt;li>&lt;code>helm install happy-panda bitnami/wordpress&lt;/code>&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>使用 helm status 来追踪 release 的状态，或是重新读取配置信息：
&lt;ul>
&lt;li>&lt;code>helm status happy-panda&lt;/code>&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;h4 id="自定义-chart">自定义 chart&lt;/h4>
&lt;ul>
&lt;li>使用 helm show values 可以查看 chart 中的可配置选项：&lt;code>helm show values bitnami/wordpress&lt;/code>&lt;/li>
&lt;/ul>
&lt;p>使用 YAML 格式的文件覆盖上述任意配置项，并在安装过程中使用该文件。&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">$ echo &amp;#39;{mariadb.auth.database: user0db, mariadb.auth.username: user0}&amp;#39; &amp;gt; values.yaml
$ helm install -f values.yaml bitnami/wordpress --generate-name
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>安装过程中有两种方式传递配置数据：&lt;/p>
&lt;ul>
&lt;li>&amp;ndash;values (或 -f)：使用 YAML 文件覆盖配置。可以指定多次，优先使用最右边的文件。&lt;/li>
&lt;li>&amp;ndash;set：通过命令行的方式对指定项进行覆盖。&lt;/li>
&lt;/ul>
&lt;h4 id="升级-release">升级 release&lt;/h4>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">helm upgrade -f panda.yaml happy-panda bitnami/wordpress
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h4 id="失败时恢复">失败时恢复&lt;/h4>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">helm rollback happy-panda 1
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h4 id="查看配置值">查看配置值&lt;/h4>
&lt;p>&lt;code>helm get values happy-panda&lt;/code>&lt;/p>
&lt;h4 id="卸载-release">卸载 release&lt;/h4>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">helm uninstall happy-panda
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>展示 Helm 保留的所有 release 记录，包括失败或删除的条目（指定了 &amp;ndash;keep-history）：&lt;code>helm list --all&lt;/code>&lt;/p></description></item><item><title>k3s手动导入镜像</title><link>https://mkbooks.github.io/blog/p/k3s%E6%89%8B%E5%8A%A8%E5%AF%BC%E5%85%A5%E9%95%9C%E5%83%8F/</link><pubDate>Fri, 19 Aug 2022 17:36:18 +0800</pubDate><guid>https://mkbooks.github.io/blog/p/k3s%E6%89%8B%E5%8A%A8%E5%AF%BC%E5%85%A5%E9%95%9C%E5%83%8F/</guid><description>&lt;p>准备镜像文件&lt;/p>
&lt;p>导入&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">sudo k3s ctr images import pause.tar.gz
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>查看&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">crictl images|grep pause
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div></description></item><item><title>k8s 驱逐节点</title><link>https://mkbooks.github.io/blog/p/k8s-%E9%A9%B1%E9%80%90%E8%8A%82%E7%82%B9/</link><pubDate>Thu, 18 Aug 2022 10:03:18 +0800</pubDate><guid>https://mkbooks.github.io/blog/p/k8s-%E9%A9%B1%E9%80%90%E8%8A%82%E7%82%B9/</guid><description>&lt;p>转载: &lt;a class="link" href="https://docs.rancher.cn/docs/rke/upgrades/configuring-strategy/_index/#%E9%A9%B1%E9%80%90%E8%8A%82%E7%82%B9" target="_blank" rel="noopener"
>https://docs.rancher.cn/docs/rke/upgrades/configuring-strategy/_index/#%E9%A9%B1%E9%80%90%E8%8A%82%E7%82%B9&lt;/a>&lt;/p>
&lt;h2 id="驱逐节点">驱逐节点&lt;/h2>
&lt;p>默认情况下，升级节点前需要使用kubectl cordon命令将节点标记为“不可用”，这个标记的目的是防止在节点在升级的过程中因为被分配到新的 pods 或者流量而中断。完成升级后，您需要使用kubectl uncordon命令将节点重新标记为“可用”，此时可以将 pods 和流量分配到该节点上。该操作不会对节点上已有的 pods 造成影响。&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">kubectl cordon node_name
kubectl uncordon node_name
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>除了将节点标记为“不可用”外，您也可以使用kubectl drain命令，在升级节点前将节点内的所有 pod 驱逐到其他节点上，并且将其标记为“不可用”，确保这个节点内在升级完成之前不会有正在运行的 pods。kubectl drain命令会导致节点内所有的 pods 被驱逐。&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">kubectl drain --ignore-daemonsets node_name
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>请参考&lt;a class="link" href="https://kubernetes.io/docs/tasks/administer-cluster/safely-drain-node/" target="_blank" rel="noopener"
>Kubernetes 官方文档&lt;/a>，了解驱逐节点的注意事项。&lt;/p>
&lt;p>注意：drain的默认值是false，如果将它的值改为true，会导致 worker 节点在升级之前被驱逐，无法升级 worker 节点。&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">upgrade_strategy:
max_unavailable_worker: 10%
max_unavailable_controlplane: 1
drain: false
node_drain_input:
force: false
ignore_daemonsets: true
delete_local_data: false
grace_period: -1 // grace period specified for each pod spec will be used
timeout: 60
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div></description></item><item><title>使用 Kubernetes API 访问集群</title><link>https://mkbooks.github.io/blog/p/%E4%BD%BF%E7%94%A8-kubernetes-api-%E8%AE%BF%E9%97%AE%E9%9B%86%E7%BE%A4/</link><pubDate>Thu, 18 Aug 2022 10:03:18 +0800</pubDate><guid>https://mkbooks.github.io/blog/p/%E4%BD%BF%E7%94%A8-kubernetes-api-%E8%AE%BF%E9%97%AE%E9%9B%86%E7%BE%A4/</guid><description>&lt;p>转载: &lt;a class="link" href="https://kubernetes.io/zh-cn/docs/tasks/administer-cluster/access-cluster-api/" target="_blank" rel="noopener"
>https://kubernetes.io/zh-cn/docs/tasks/administer-cluster/access-cluster-api/&lt;/a>&lt;/p>
&lt;h1 id="访问集群-api">访问集群 API&lt;/h1></description></item><item><title>k8s强制删除pod&amp;pv&amp;pvc和ns&amp;namespace方法</title><link>https://mkbooks.github.io/blog/p/k8s%E5%BC%BA%E5%88%B6%E5%88%A0%E9%99%A4podpvpvc%E5%92%8Cnsnamespace%E6%96%B9%E6%B3%95/</link><pubDate>Wed, 17 Aug 2022 11:03:18 +0800</pubDate><guid>https://mkbooks.github.io/blog/p/k8s%E5%BC%BA%E5%88%B6%E5%88%A0%E9%99%A4podpvpvc%E5%92%8Cnsnamespace%E6%96%B9%E6%B3%95/</guid><description>&lt;p>转载: &lt;a class="link" href="https://www.cnblogs.com/fengdejiyixx/p/15186831.html" target="_blank" rel="noopener"
>https://www.cnblogs.com/fengdejiyixx/p/15186831.html&lt;/a>&lt;/p>
&lt;p>注意：以下操作方法十分危险，三思而行！！！&lt;/p>
&lt;p>如果名称空间、pod、pv、pvc全部处于“Terminating”状态时，此时的该名称空间下的所有控制器都已经被删除了，之所以出现pod、pvc、pv、ns无法删除，那是因为kubelet 阻塞，有其他的资源在使用该namespace，比如CRD等，尝试重启kubelet，再删除该namespace 也不好使。&lt;/p>
&lt;p>正确的删除方法：删除pod&amp;ndash;&amp;gt; 删除pvc &amp;mdash;&amp;gt; 删除pv &amp;ndash;&amp;gt; 删除名称空间&lt;/p>
&lt;h1 id="1-强制删除pod">1. 强制删除pod&lt;/h1>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">kubectl delete pod &amp;lt;your-pod-name&amp;gt; -n &amp;lt;name-space&amp;gt; --force --grace-period=0
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>解决方法：加参数 &amp;ndash;force &amp;ndash;grace-period=0，grace-period表示过渡存活期，默认30s，在删除POD之前允许POD慢慢终止其上的容器进程，从而优雅退出，0表示立即终止POD&lt;/p>
&lt;h1 id="2-强制删除pvpvc">2. 强制删除pv、pvc&lt;/h1>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">kubectl patch pv xxx -p &amp;#39;{&amp;#34;metadata&amp;#34;:{&amp;#34;finalizers&amp;#34;:null}}&amp;#39;
kubectl patch pvc xxx -p &amp;#39;{&amp;#34;metadata&amp;#34;:{&amp;#34;finalizers&amp;#34;:null}}&amp;#39;
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>直接删除 k8s etcd 数据库中的记录！&lt;/p>
&lt;h1 id="3-强制删除ns">3. 强制删除ns&lt;/h1>
&lt;p>在尝试以下命令强制删除也不好使：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">kubectl delete ns &amp;lt;terminating-namespace&amp;gt; --force --grace-period=0
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>解决方法：&lt;/p>
&lt;p>1）运行以下命令以查看处于“Terminating”状态的namespace：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">kubectl get namespaces
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>2）选择一个Terminating namespace，并查看namespace 中的 finalizer。运行以下命令：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">$ kubectl get namespace &amp;lt;terminating-namespace&amp;gt; -o yaml
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>输出信息如下：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">apiVersion: v1
kind: Namespace
metadata:
creationTimestamp: &amp;#34;2019-11-20T15:18:06Z&amp;#34;
deletionTimestamp: &amp;#34;2020-01-16T02:50:02Z&amp;#34;
name: &amp;lt;terminating-namespace&amp;gt;
resourceVersion: &amp;#34;3249493&amp;#34;
selfLink: /api/v1/namespaces/knative-eventing
uid: f300ea38-c8c2-4653-b432-b66103e412db
spec:
finalizers:
- kubernetes
status:
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>3）导出json格式到文件&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">kubectl get namespace &amp;lt;terminating-namespace&amp;gt; -o json &amp;gt;tmp.json
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>4）编辑tmp.josn，删除finalizers 字段的值&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">{
&amp;#34;apiVersion&amp;#34;: &amp;#34;v1&amp;#34;,
&amp;#34;kind&amp;#34;: &amp;#34;Namespace&amp;#34;,
&amp;#34;metadata&amp;#34;: {
&amp;#34;creationTimestamp&amp;#34;: &amp;#34;2019-11-20T15:18:06Z&amp;#34;,
&amp;#34;deletionTimestamp&amp;#34;: &amp;#34;2020-01-16T02:50:02Z&amp;#34;,
&amp;#34;name&amp;#34;: &amp;#34;&amp;lt;terminating-namespace&amp;gt;&amp;#34;,
&amp;#34;resourceVersion&amp;#34;: &amp;#34;3249493&amp;#34;,
&amp;#34;selfLink&amp;#34;: &amp;#34;/api/v1/namespaces/knative-eventing&amp;#34;,
&amp;#34;uid&amp;#34;: &amp;#34;f300ea38-c8c2-4653-b432-b66103e412db&amp;#34;
},
&amp;#34;spec&amp;#34;: { #从此行开始删除
&amp;#34;finalizers&amp;#34;: []
}, # 删到此行
&amp;#34;status&amp;#34;: {
&amp;#34;phase&amp;#34;: &amp;#34;Terminating&amp;#34;
}
}
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>5）开启proxy&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">kubectl proxy
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>执行该命令后，当前终端会被卡住
6）打开新的一个窗口，执行以下命令&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">curl -k -H &amp;#34;Content-Type: application/json&amp;#34; -X PUT --data-binary @tmp.json http://127.0.0.1:8001/api/v1/namespaces/&amp;lt;terminating-namespace&amp;gt;/finalize
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>输出信息如下：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">{
&amp;#34;kind&amp;#34;: &amp;#34;Namespace&amp;#34;,
&amp;#34;apiVersion&amp;#34;: &amp;#34;v1&amp;#34;,
&amp;#34;metadata&amp;#34;: {
&amp;#34;name&amp;#34;: &amp;#34;istio-system&amp;#34;,
&amp;#34;selfLink&amp;#34;: &amp;#34;/api/v1/namespaces/istio-system/finalize&amp;#34;,
&amp;#34;uid&amp;#34;: &amp;#34;2e274537-727f-4a8f-ae8c-397473ed619a&amp;#34;,
&amp;#34;resourceVersion&amp;#34;: &amp;#34;3249492&amp;#34;,
&amp;#34;creationTimestamp&amp;#34;: &amp;#34;2019-11-20T15:18:06Z&amp;#34;,
&amp;#34;deletionTimestamp&amp;#34;: &amp;#34;2020-01-16T02:50:02Z&amp;#34;
},
&amp;#34;spec&amp;#34;: {
},
&amp;#34;status&amp;#34;: {
&amp;#34;phase&amp;#34;: &amp;#34;Terminating&amp;#34;
}
}
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>7）确认处于Terminating 状态的namespace已经被删除&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">kubectl get namespaces
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>如果还有处于Terminating 状态的namespace，重复以上操作，删除即可！&lt;/p></description></item><item><title>k8s的namespace一直Terminating的完美解决方案</title><link>https://mkbooks.github.io/blog/p/k8s%E7%9A%84namespace%E4%B8%80%E7%9B%B4terminating%E7%9A%84%E5%AE%8C%E7%BE%8E%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88/</link><pubDate>Wed, 17 Aug 2022 11:03:18 +0800</pubDate><guid>https://mkbooks.github.io/blog/p/k8s%E7%9A%84namespace%E4%B8%80%E7%9B%B4terminating%E7%9A%84%E5%AE%8C%E7%BE%8E%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88/</guid><description>&lt;p>转载: &lt;a class="link" href="https://www.cnblogs.com/zisefeizhu/p/13786053.html" target="_blank" rel="noopener"
>https://www.cnblogs.com/zisefeizhu/p/13786053.html&lt;/a>&lt;/p>
&lt;p>在k8s集群中进行测试删除namespace是经常的事件，而为了方便操作，一般都是直接对整个名称空间进行删除操作。
相信道友们在进行此步操作的时候，会遇到要删除的namespace一直处于Terminating。下面我将给出一个完美的解决方案，&lt;/p>
&lt;p>测试demo&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">创建demo namespace
# kubectl create ns test
namespace/test created
删除demo namespace
# kubectl delete ns test
namespace &amp;#34;test&amp;#34; deleted
一直处于deleted不见exit
查看状态 可见test namespace 处于Terminating
# kubectl get ns -w
NAME STATUS AGE
test Terminating 18s
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>下面给出一种完美的解决方案：调用接口删除&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;span class="lnt">33
&lt;/span>&lt;span class="lnt">34
&lt;/span>&lt;span class="lnt">35
&lt;/span>&lt;span class="lnt">36
&lt;/span>&lt;span class="lnt">37
&lt;/span>&lt;span class="lnt">38
&lt;/span>&lt;span class="lnt">39
&lt;/span>&lt;span class="lnt">40
&lt;/span>&lt;span class="lnt">41
&lt;/span>&lt;span class="lnt">42
&lt;/span>&lt;span class="lnt">43
&lt;/span>&lt;span class="lnt">44
&lt;/span>&lt;span class="lnt">45
&lt;/span>&lt;span class="lnt">46
&lt;/span>&lt;span class="lnt">47
&lt;/span>&lt;span class="lnt">48
&lt;/span>&lt;span class="lnt">49
&lt;/span>&lt;span class="lnt">50
&lt;/span>&lt;span class="lnt">51
&lt;/span>&lt;span class="lnt">52
&lt;/span>&lt;span class="lnt">53
&lt;/span>&lt;span class="lnt">54
&lt;/span>&lt;span class="lnt">55
&lt;/span>&lt;span class="lnt">56
&lt;/span>&lt;span class="lnt">57
&lt;/span>&lt;span class="lnt">58
&lt;/span>&lt;span class="lnt">59
&lt;/span>&lt;span class="lnt">60
&lt;/span>&lt;span class="lnt">61
&lt;/span>&lt;span class="lnt">62
&lt;/span>&lt;span class="lnt">63
&lt;/span>&lt;span class="lnt">64
&lt;/span>&lt;span class="lnt">65
&lt;/span>&lt;span class="lnt">66
&lt;/span>&lt;span class="lnt">67
&lt;/span>&lt;span class="lnt">68
&lt;/span>&lt;span class="lnt">69
&lt;/span>&lt;span class="lnt">70
&lt;/span>&lt;span class="lnt">71
&lt;/span>&lt;span class="lnt">72
&lt;/span>&lt;span class="lnt">73
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">开启一个代理终端
# kubectl proxy
Starting to serve on 127.0.0.1:8001
再开启一个操作终端
将test namespace的配置文件输出保存
# kubectl get ns test -o json &amp;gt; test.json
删除spec及status部分的内容还有metadata字段后的&amp;#34;,&amp;#34;号，切记！
剩下内容大致如下
{
&amp;#34;apiVersion&amp;#34;: &amp;#34;v1&amp;#34;,
&amp;#34;kind&amp;#34;: &amp;#34;Namespace&amp;#34;,
&amp;#34;metadata&amp;#34;: {
&amp;#34;annotations&amp;#34;: {
&amp;#34;cattle.io/status&amp;#34;: &amp;#34;{\&amp;#34;Conditions\&amp;#34;:[{\&amp;#34;Type\&amp;#34;:\&amp;#34;ResourceQuotaInit\&amp;#34;,\&amp;#34;Status\&amp;#34;:\&amp;#34;True\&amp;#34;,\&amp;#34;Message\&amp;#34;:\&amp;#34;\&amp;#34;,\&amp;#34;LastUpdateTime\&amp;#34;:\&amp;#34;2020-10-09T07:12:17Z\&amp;#34;},{\&amp;#34;Type\&amp;#34;:\&amp;#34;InitialRolesPopulated\&amp;#34;,\&amp;#34;Status\&amp;#34;:\&amp;#34;True\&amp;#34;,\&amp;#34;Message\&amp;#34;:\&amp;#34;\&amp;#34;,\&amp;#34;LastUpdateTime\&amp;#34;:\&amp;#34;2020-10-09T07:12:18Z\&amp;#34;}]}&amp;#34;,
&amp;#34;lifecycle.cattle.io/create.namespace-auth&amp;#34;: &amp;#34;true&amp;#34;
},
&amp;#34;creationTimestamp&amp;#34;: &amp;#34;2020-10-09T07:12:16Z&amp;#34;,
&amp;#34;deletionTimestamp&amp;#34;: &amp;#34;2020-10-09T07:12:22Z&amp;#34;,
&amp;#34;name&amp;#34;: &amp;#34;test&amp;#34;,
&amp;#34;resourceVersion&amp;#34;: &amp;#34;471648079&amp;#34;,
&amp;#34;selfLink&amp;#34;: &amp;#34;/api/v1/namespaces/test&amp;#34;,
&amp;#34;uid&amp;#34;: &amp;#34;862d311e-d87a-48c2-bc48-332a4db9dbdb&amp;#34;
}
}
调接口删除
# curl -k -H &amp;#34;Content-Type: application/json&amp;#34; -X PUT --data-binary @test.json http://127.0.0.1:8001/api/v1/namespaces/test/finalize
{
&amp;#34;kind&amp;#34;: &amp;#34;Namespace&amp;#34;,
&amp;#34;apiVersion&amp;#34;: &amp;#34;v1&amp;#34;,
&amp;#34;metadata&amp;#34;: {
&amp;#34;name&amp;#34;: &amp;#34;test&amp;#34;,
&amp;#34;selfLink&amp;#34;: &amp;#34;/api/v1/namespaces/test/finalize&amp;#34;,
&amp;#34;uid&amp;#34;: &amp;#34;862d311e-d87a-48c2-bc48-332a4db9dbdb&amp;#34;,
&amp;#34;resourceVersion&amp;#34;: &amp;#34;471648079&amp;#34;,
&amp;#34;creationTimestamp&amp;#34;: &amp;#34;2020-10-09T07:12:16Z&amp;#34;,
&amp;#34;deletionTimestamp&amp;#34;: &amp;#34;2020-10-09T07:12:22Z&amp;#34;,
&amp;#34;annotations&amp;#34;: {
&amp;#34;cattle.io/status&amp;#34;: &amp;#34;{\&amp;#34;Conditions\&amp;#34;:[{\&amp;#34;Type\&amp;#34;:\&amp;#34;ResourceQuotaInit\&amp;#34;,\&amp;#34;Status\&amp;#34;:\&amp;#34;True\&amp;#34;,\&amp;#34;Message\&amp;#34;:\&amp;#34;\&amp;#34;,\&amp;#34;LastUpdateTime\&amp;#34;:\&amp;#34;2020-10-09T07:12:17Z\&amp;#34;},{\&amp;#34;Type\&amp;#34;:\&amp;#34;InitialRolesPopulated\&amp;#34;,\&amp;#34;Status\&amp;#34;:\&amp;#34;True\&amp;#34;,\&amp;#34;Message\&amp;#34;:\&amp;#34;\&amp;#34;,\&amp;#34;LastUpdateTime\&amp;#34;:\&amp;#34;2020-10-09T07:12:18Z\&amp;#34;}]}&amp;#34;,
&amp;#34;lifecycle.cattle.io/create.namespace-auth&amp;#34;: &amp;#34;true&amp;#34;
}
},
&amp;#34;spec&amp;#34;: {
},
&amp;#34;status&amp;#34;: {
&amp;#34;phase&amp;#34;: &amp;#34;Terminating&amp;#34;,
&amp;#34;conditions&amp;#34;: [
{
&amp;#34;type&amp;#34;: &amp;#34;NamespaceDeletionDiscoveryFailure&amp;#34;,
&amp;#34;status&amp;#34;: &amp;#34;True&amp;#34;,
&amp;#34;lastTransitionTime&amp;#34;: &amp;#34;2020-10-09T07:12:27Z&amp;#34;,
&amp;#34;reason&amp;#34;: &amp;#34;DiscoveryFailed&amp;#34;,
&amp;#34;message&amp;#34;: &amp;#34;Discovery failed for some groups, 1 failing: unable to retrieve the complete list of server APIs: metrics.k8s.io/v1beta1: the server is currently unable to handle the request&amp;#34;
},
{
&amp;#34;type&amp;#34;: &amp;#34;NamespaceDeletionGroupVersionParsingFailure&amp;#34;,
&amp;#34;status&amp;#34;: &amp;#34;False&amp;#34;,
&amp;#34;lastTransitionTime&amp;#34;: &amp;#34;2020-10-09T07:12:28Z&amp;#34;,
&amp;#34;reason&amp;#34;: &amp;#34;ParsedGroupVersions&amp;#34;,
&amp;#34;message&amp;#34;: &amp;#34;All legacy kube types successfully parsed&amp;#34;
},
{
&amp;#34;type&amp;#34;: &amp;#34;NamespaceDeletionContentFailure&amp;#34;,
&amp;#34;status&amp;#34;: &amp;#34;False&amp;#34;,
&amp;#34;lastTransitionTime&amp;#34;: &amp;#34;2020-10-09T07:12:28Z&amp;#34;,
&amp;#34;reason&amp;#34;: &amp;#34;ContentDeleted&amp;#34;,
&amp;#34;message&amp;#34;: &amp;#34;All content successfully deleted&amp;#34;
}
]
}
}
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>查看结果&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;span class="lnt">8
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">1、delete 状态终止
kubectl delete ns test
namespace &amp;#34;test&amp;#34; deleted
2、Terminating状态终止
kubectl get ns -w
test Terminating 18s
test Terminating 17m
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>名称空间被删除掉&lt;/p></description></item></channel></rss>